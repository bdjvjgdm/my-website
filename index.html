<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω ƒêi·ªÉm Thi ƒêua</title>
    <!-- T√≠ch h·ª£p Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- T·∫£i c√°c th∆∞ vi·ªán Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Kh·ªüi t·∫°o Firebase -->
    <script>
      // IMPORTANT: Replace with your actual Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDaeedEmbpGg_rr2ln13lWsXKY-opoy36E",
        authDomain: "quanlydiem-c2820.firebaseapp.com",
        projectId: "quanlydiem-c2820",
        storageBucket: "quanlydiem-c2820.appspot.com",
        messagingSenderId: "912711399959",
        appId: "1:912711399959:web:08e5897d6b958c1371fa52",
      };
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      window.auth = firebase.auth();
    </script>

    <style>
      /* --- STYLES FOR THE ENTIRE APP --- */
      body {
        font-family: "Poppins", sans-serif;
        background-color: #0a092d;
        background-image: url("https://images.unsplash.com/photo-1532372576292-a42302244248?q=80&w=2574&auto=format&fit=crop");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color: #e0e0e0;
      }

      .card {
        background-color: rgba(16, 15, 58, 0.6);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }

      h1,
      h2,
      h3 {
        color: #ffffff;
        text-shadow: 0 0 10px rgba(167, 139, 250, 0.5);
      }

      .input-field {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #f0f0f0;
        transition: all 0.3s ease;
      }
      .input-field::placeholder {
        color: #a0aec0;
      }
      .input-field:focus {
        outline: none;
        border-color: #a78bfa;
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3);
      }
      .input-field:disabled {
        background-color: rgba(0, 0, 0, 0.2);
        cursor: not-allowed;
        color: #9ca3af;
      }

      .btn {
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        border: none;
        color: white;
        font-weight: bold;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3);
      }
      .btn-primary {
        background: linear-gradient(45deg, #4f46e5, #c026d3);
      }
      .btn-secondary {
        background: linear-gradient(45deg, #dd6b20, #fbbf24);
      }
      .btn-danger {
        background: linear-gradient(45deg, #dc2626, #f87171);
      }
      .btn-ai {
        background: linear-gradient(45deg, #6366f1, #3b82f6);
      }
      .btn-gray {
        background-color: #4a5568;
      }
      .btn-gray:hover {
        background-color: #2d3748;
      }
      .btn-subtle {
        background-color: transparent;
        color: #a78bfa;
        font-weight: 500;
      }
      .btn-subtle:hover {
        color: #c4b5fd;
      }

      .drop-zone {
        background-color: rgba(0, 0, 0, 0.25);
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        min-height: 200px;
      }
      .drop-zone.drag-over {
        border-color: #818cf8;
        background-color: rgba(79, 70, 229, 0.1);
        box-shadow: inset 0 0 10px rgba(129, 140, 248, 0.5);
      }

      .student-card {
        cursor: grab;
        transition: all 0.2s;
        position: relative;
        background-color: rgba(40, 40, 80, 0.8);
        border: 1px solid rgba(167, 139, 250, 0.5);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        padding: 0.5rem;
      }
      .student-card:active {
        cursor: grabbing;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(167, 139, 250, 0.3);
      }
      .student-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
      }
      .student-card .student-id {
        font-weight: 700;
        color: #c4b5fd;
      }
      .student-card .student-name {
        color: #e5e7eb;
      }
      .student-card .student-score {
        color: #fcd34d;
        margin-top: 2px;
        font-weight: bold;
      }

      .fab {
        position: fixed;
        right: 30px;
        width: 60px;
        height: 60px;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(192, 132, 252, 0.5);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        border: 2px solid rgba(255, 255, 255, 0.5);
      }
      .fab-secondary {
        background: linear-gradient(135deg, #d946ef, #8b5cf6);
        bottom: 100px;
      }
      .fab-tertiary {
        background: linear-gradient(135deg, #3b82f6, #14b8a6);
        bottom: 30px;
      }
      .fab:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 0 30px rgba(192, 132, 252, 0.8);
      }

      table {
        border-collapse: separate;
        border-spacing: 0;
      }
      th,
      td {
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px;
        text-align: center;
        vertical-align: middle;
      }
      thead th {
        background-color: rgba(0, 0, 0, 0.4);
        font-weight: 600;
        color: #c4b5fd;
      }
      tbody tr {
        background-color: rgba(255, 255, 255, 0.05);
      }
      tbody tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .table-input {
        background-color: rgba(0, 0, 0, 0.4);
        border: 1px solid #4a5568;
        color: white;
        width: 100%;
        min-width: 40px;
        padding: 4px;
        border-radius: 4px;
        text-align: center;
      }
      .table-input:focus {
        border-color: #a78bfa;
        background-color: rgba(0, 0, 0, 0.6);
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #a78bfa;
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .seat {
        width: 55px;
        height: 55px;
        border: 2px solid #4a5568;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        transition: all 0.2s;
      }
      .seat.occupied {
        background-color: rgba(192, 132, 252, 0.2);
        border-color: #c084fc;
        box-shadow: 0 0 15px rgba(192, 132, 252, 0.5);
        cursor: grab;
      }
      .seat.drag-over,
      #unassigned-students-list.drag-over {
        border-style: solid;
        border-color: #818cf8;
        background-color: rgba(79, 70, 229, 0.1);
        box-shadow: inset 0 0 10px rgba(129, 140, 248, 0.5);
      }
      .desk {
        display: flex;
        gap: 8px;
      }
      .student-in-seat {
        font-size: 10px;
        text-align: center;
        line-height: 1.2;
        word-break: break-word;
        color: #f0f0f0;
      }
      .student-in-seat .font-bold {
        color: #d8b4fe;
      }

      .classroom-feature {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        color: #a78bfa;
      }
      #individual-scoring-page thead th,
      #historical-week-details-page thead th {
        font-size: 11px;
        padding: 4px 2px;
        white-space: normal;
        vertical-align: middle;
      }
      #individual-scoring-page .min-w-\[120px\],
      #historical-week-details-page .min-w-\[120px\] {
        min-width: 120px;
      }

      .feedback-item {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 0.75rem;
        border-radius: 0.5rem;
        border-left: 4px solid transparent;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .feedback-item.unread {
        background-color: rgba(167, 139, 250, 0.15);
        border-left-color: #a78bfa;
      }
      .feedback-meta {
        font-size: 0.75rem;
        color: #a0aec0;
      }
      .feedback-content {
        font-size: 0.875rem;
        color: #e0e0e0;
        margin: 0.5rem 0;
      }
      .delete-feedback-btn {
        font-size: 1.25rem;
        cursor: pointer;
        color: #9ca3af;
        transition: color 0.2s;
      }
      .delete-feedback-btn:hover {
        color: #f87171;
      }

      /* --- NEW LOGIN PAGE STYLES --- */
      #login-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2px;
        flex-wrap: wrap;
        overflow: hidden;
        background: #0a092d;
      }
      #login-background::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(#0a092d, #4f46e5, #0a092d);
        animation: animate-login-bg 5s linear infinite;
      }
      @keyframes animate-login-bg {
        0% {
          transform: translateY(-100%);
        }
        100% {
          transform: translateY(100%);
        }
      }

      #login-background span {
        position: relative;
        display: block;
        width: calc(6.25vw - 2px);
        height: calc(6.25vw - 2px);
        background: #181818;
        z-index: 2;
        transition: 1.5s;
      }
      #login-background span:hover {
        background: #a78bfa;
        transition: 0s;
      }

      .signin {
        position: relative;
        width: 400px;
        background: #222;
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        border-radius: 4px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 9);
      }
      .signin .content {
        position: relative;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 20px; /* Reduced gap */
      }
      .signin .content h2 {
        font-size: 2em;
        color: #a78bfa;
        text-transform: uppercase;
      }
      .signin .content .form {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px; /* Reduced gap */
      }
      .signin .content .form .inputBox {
        position: relative;
        width: 100%;
      }
      .signin .content .form .inputBox input {
        position: relative;
        width: 100%;
        background: #333;
        border: none;
        outline: none;
        padding: 25px 10px 7.5px;
        border-radius: 4px;
        color: #fff;
        font-weight: 500;
        font-size: 1em;
      }
      .signin .content .form .inputBox i {
        position: absolute;
        left: 0;
        padding: 15px 10px;
        font-style: normal;
        color: #aaa;
        transition: 0.5s;
        pointer-events: none;
      }
      .signin .content .form .inputBox input:focus ~ i,
      .signin .content .form .inputBox input:valid ~ i {
        transform: translateY(-7.5px);
        font-size: 0.8em;
        color: #fff;
      }
      .signin .content .form .links {
        width: 100%;
        text-align: right;
      }
      .signin .content .form .links a {
        color: #aaa;
        text-decoration: none;
        font-size: 0.9em;
      }
      .signin .content .form .links a:hover {
        color: #a78bfa;
      }

      .signin .content .form .inputBox input[type="button"] {
        padding: 10px;
        background: #a78bfa;
        color: #111;
        font-weight: 600;
        font-size: 1.35em;
        letter-spacing: 0.05em;
        cursor: pointer;
        margin-top: 10px;
      }
      input[type="button"]:active {
        opacity: 0.6;
      }

      @media (max-width: 900px) {
        #login-background span {
          width: calc(10vw - 2px);
          height: calc(10vw - 2px);
        }
      }
      @media (max-width: 600px) {
        #login-background span {
          width: calc(20vw - 2px);
          height: calc(20vw - 2px);
        }
      }
    </style>
  </head>
  <body>
    <section id="login-background">
      <!-- Background spans will be generated by JS -->
    </section>

    <div id="app-container" class="min-h-screen w-full p-4">
      <!-- Trang ƒêƒÉng Nh·∫≠p -->
      <div
        id="login-page"
        class="hidden h-full w-full flex items-center justify-center"
      >
        <div class="signin">
          <div class="content">
            <h2>H·ªá Th·ªëng Thi ƒêua</h2>
            <div class="form">
              <div class="inputBox">
                <input type="email" id="email" required />
                <i>Email</i>
              </div>
              <div class="inputBox">
                <input type="password" id="password" required />
                <i>M·∫≠t kh·∫©u</i>
              </div>
              <div class="links">
                <a href="#">Qu√™n m·∫≠t kh·∫©u?</a>
              </div>
              <div
                id="login-error"
                class="text-red-400 text-sm text-center -mt-2 hidden"
              ></div>
              <div class="inputBox">
                <input
                  type="button"
                  value="ƒêƒÉng Nh·∫≠p"
                  onclick="handleLogin()"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trang Ch√≠nh - Qu·∫£n L√Ω -->
      <div id="main-page" class="hidden w-full max-w-7xl mx-auto">
        <div class="card shadow-xl rounded-2xl p-8 space-y-8">
          <div
            class="flex justify-between items-start border-b border-gray-700 pb-4"
          >
            <div>
              <h1 class="text-3xl font-bold">B·∫£ng Qu·∫£n L√Ω Thi ƒêua</h1>
              <p class="text-gray-400">T·ªïng quan c√°c t·ªï v√† ch·ª©c nƒÉng</p>
            </div>
            <div class="text-right">
              <div
                id="user-info"
                class="text-sm font-medium text-gray-300"
              ></div>
              <button
                onclick="handleLogout()"
                class="text-sm font-medium btn-subtle"
              >
                ƒêƒÉng xu·∫•t
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div id="left-column-main" class="lg:col-span-1 space-y-6">
              <!-- Admin Feedback Viewer -->
              <div
                id="admin-feedback-viewer"
                class="hidden bg-black bg-opacity-20 p-6 rounded-lg border border-gray-700 space-y-4"
              >
                <h2 class="text-xl font-semibold mb-2 text-center">
                  üì• H√≤m Th∆∞ Ph·∫£n H·ªìi
                </h2>
                <div
                  id="feedback-list"
                  class="space-y-3 max-h-60 overflow-y-auto pr-2"
                >
                  <!-- Feedback messages will be loaded here -->
                </div>
              </div>

              <!-- Viewer Actions section -->
              <div
                id="viewer-actions-section"
                class="hidden bg-black bg-opacity-20 p-6 rounded-lg border border-gray-700 space-y-4"
              >
                <h2 class="text-xl font-semibold mb-2">Ch·ª©c NƒÉng Viewer</h2>
                <button
                  onclick="openFeedbackModal()"
                  class="w-full py-3 px-4 rounded-lg text-sm btn btn-secondary"
                >
                  ‚úâÔ∏è G·ª≠i Ph·∫£n H·ªìi T·ªõi Gi√°o Vi√™n
                </button>
              </div>

              <div
                id="functions-section"
                class="bg-black bg-opacity-20 p-6 rounded-lg border border-gray-700 space-y-4"
              >
                <h2 class="text-xl font-semibold mb-2">Ch·ª©c nƒÉng</h2>
                <button
                  onclick="getAIFeedback()"
                  class="w-full py-3 px-4 rounded-lg text-sm btn btn-ai"
                >
                  ‚ú® Nh·∫≠n X√©t Tu·∫ßn t·ª´ AI
                </button>
                <button
                  id="finalize-week-button"
                  onclick="openFinalizeWeekModal()"
                  class="hidden w-full py-3 px-4 rounded-lg text-sm btn btn-primary"
                >
                  Ch·ªët ƒêi·ªÉm Tu·∫ßn
                </button>
                <button
                  id="clear-data-button"
                  onclick="openClearDataModal()"
                  class="hidden w-full py-3 px-4 rounded-lg text-sm btn btn-danger"
                >
                  X√≥a S·∫°ch D·ªØ Li·ªáu
                </button>
                <div
                  id="add-student-section"
                  class="hidden pt-4 border-t border-gray-700 space-y-3"
                >
                  <h3 class="text-lg font-semibold text-center">
                    Th√™m H·ªçc Sinh M·ªõi
                  </h3>
                  <div>
                    <label for="new-student-name" class="text-sm"
                      >T√™n H·ªçc Sinh:</label
                    >
                    <input
                      type="text"
                      id="new-student-name"
                      class="input-field w-full mt-1 rounded-md"
                      placeholder="V√µ Th√†nh M·∫°nh"
                    />
                  </div>
                  <div>
                    <label for="new-student-group" class="text-sm">T·ªï:</label>
                    <input
                      type="number"
                      id="new-student-group"
                      class="input-field w-full mt-1 rounded-md"
                      min="1"
                      max="4"
                      placeholder="1"
                    />
                  </div>
                  <button
                    onclick="addStudent()"
                    class="w-full py-2 px-4 rounded-lg text-sm btn btn-secondary"
                  >
                    Th√™m H·ªçc Sinh
                  </button>
                </div>
              </div>

              <div
                id="leaderboard-section"
                class="bg-black bg-opacity-20 p-6 rounded-lg border border-gray-700 space-y-4"
              >
                <h2 class="text-xl font-semibold mb-2 text-center">
                  üèÜ B·∫£ng X·∫øp H·∫°ng Tu·∫ßn üèÜ
                </h2>
                <div id="leaderboard-list" class="space-y-3">
                  <!-- Leaderboard content will be generated by JS -->
                </div>
              </div>
            </div>
            <div class="lg:col-span-2">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div
                  class="bg-black bg-opacity-20 p-4 rounded-lg border border-gray-700 flex flex-col"
                >
                  <h3 class="font-semibold text-center mb-2">T·ªï 1</h3>
                  <div
                    id="group-1"
                    data-groupid="1"
                    class="drop-zone grid grid-cols-2 gap-2 flex-grow p-2"
                  ></div>
                  <button
                    id="score-group-1-btn"
                    onclick="goToScoringPage(1)"
                    class="mt-4 w-full py-2 px-4 rounded-lg text-sm btn btn-primary hidden"
                  >
                    Ch·∫•m ƒêi·ªÉm T·ªï 1
                  </button>
                </div>
                <div
                  class="bg-black bg-opacity-20 p-4 rounded-lg border border-gray-700 flex flex-col"
                >
                  <h3 class="font-semibold text-center mb-2">T·ªï 2</h3>
                  <div
                    id="group-2"
                    data-groupid="2"
                    class="drop-zone grid grid-cols-2 gap-2 flex-grow p-2"
                  ></div>
                  <button
                    id="score-group-2-btn"
                    onclick="goToScoringPage(2)"
                    class="mt-4 w-full py-2 px-4 rounded-lg text-sm btn btn-primary hidden"
                  >
                    Ch·∫•m ƒêi·ªÉm T·ªï 2
                  </button>
                </div>
                <div
                  class="bg-black bg-opacity-20 p-4 rounded-lg border border-gray-700 flex flex-col"
                >
                  <h3 class="font-semibold text-center mb-2">T·ªï 3</h3>
                  <div
                    id="group-3"
                    data-groupid="3"
                    class="drop-zone grid grid-cols-2 gap-2 flex-grow p-2"
                  ></div>
                  <button
                    id="score-group-3-btn"
                    onclick="goToScoringPage(3)"
                    class="mt-4 w-full py-2 px-4 rounded-lg text-sm btn btn-primary hidden"
                  >
                    Ch·∫•m ƒêi·ªÉm T·ªï 3
                  </button>
                </div>
                <div
                  class="bg-black bg-opacity-20 p-4 rounded-lg border border-gray-700 flex flex-col"
                >
                  <h3 class="font-semibold text-center mb-2">T·ªï 4</h3>
                  <div
                    id="group-4"
                    data-groupid="4"
                    class="drop-zone grid grid-cols-2 gap-2 flex-grow p-2"
                  ></div>
                  <button
                    id="score-group-4-btn"
                    onclick="goToScoringPage(4)"
                    class="mt-4 w-full py-2 px-4 rounded-lg text-sm btn btn-primary hidden"
                  >
                    Ch·∫•m ƒêi·ªÉm T·ªï 4
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- S·ªï Theo D√µi Thi ƒêua -->
      <div
        id="individual-scoring-page"
        class="hidden w-full max-w-screen-xl mx-auto"
      >
        <div class="card shadow-xl rounded-2xl p-6 md:p-8 space-y-6">
          <h1
            id="scoring-page-title"
            class="text-2xl md:text-3xl font-bold text-center"
          >
            S·ªî THEO D√ïI THI ƒêUA
          </h1>
          <input
            type="text"
            id="scoring-page-subtitle"
            class="text-center text-gray-400 -mt-4 bg-transparent w-full border-0 focus:ring-0 focus:outline-none disabled:cursor-default"
            onchange="handleSubtitleChange(this)"
            disabled
          />
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead>
                <tr>
                  <th rowspan="2">STT</th>
                  <th rowspan="2" class="min-w-[120px]">T√™n</th>
                  <th colspan="10">ƒêi·ªÉm c·ªông / tr·ª´ (l·∫ßn)</th>
                  <th rowspan="2">T·ªïng ƒëi·ªÉm</th>
                  <th rowspan="2">X·∫øp lo·∫°i</th>
                </tr>
                <tr>
                  <th>ƒêi·ªÉm<br />t·ªët</th>
                  <th>B·ªã ghi<br />SƒêB<br />(-20)</th>
                  <th>N√≥i<br />chuy·ªán<br />(-10)</th>
                  <th>S·ª≠ d·ª•ng<br />ƒëi·ªán tho·∫°i<br />(-50)</th>
                  <th>GV<br />nh·∫Øc nh·ªü<br />(-10)</th>
                  <th>Xem t√†i<br />li·ªáu, KTC<br />(-50)</th>
                  <th>Trang<br />ph·ª•c, KQ<br />(-10)</th>
                  <th>Kh√¥ng<br />h·ªçc b√†i<br />(-20)</th>
                  <th>Ph√°t bi·ªÉu<br />x√¢y d·ª±ng<br />(+10)</th>
                  <th>Tham gia<br />phong tr√†o<br />(+50)</th>
                </tr>
              </thead>
              <tbody id="individual-scoring-tbody"></tbody>
              <tfoot class="font-bold">
                <tr>
                  <td colspan="2">T·ªîNG ƒêI·ªÇM</td>
                  <td id="total-col-diemtot">0</td>
                  <td id="total-col-ghisodb">0</td>
                  <td id="total-col-noichuyen">0</td>
                  <td id="total-col-sudungdienthoai">0</td>
                  <td id="total-col-gvnhacnho">0</td>
                  <td id="total-col-xemtailieu">0</td>
                  <td id="total-col-trangphuc">0</td>
                  <td id="total-col-khonghocbai">0</td>
                  <td id="total-col-phatbieu">0</td>
                  <td id="total-col-thamgiaphongtrao">0</td>
                  <td id="total-final" class="bg-purple-900 text-lg">0</td>
                  <td></td>
                  <!-- Empty cell for Xep Loai footer -->
                </tr>
              </tfoot>
            </table>
          </div>
          <div
            class="text-left text-sm text-gray-300 border-t border-gray-700 pt-4"
          >
            <p>
              <strong class="text-purple-300">Ghi ch√∫:</strong> M·ªói b·∫°n c√≥ 50
              ƒëi·ªÉm kh·ªüi ƒë·∫ßu.
            </p>
            <p><strong class="text-purple-300">Quy ƒë·ªãnh x·∫øp lo·∫°i:</strong></p>
            <ul class="list-disc list-inside ml-4">
              <li>
                <strong class="text-green-400">T·ªët:</strong> t·ª´ 90 ƒëi·ªÉm tr·ªü l√™n
              </li>
              <li>
                <strong class="text-blue-400">Kh√°:</strong> t·ª´ 65 ƒë·∫øn d∆∞·ªõi 90
                ƒëi·ªÉm
              </li>
              <li>
                <strong class="text-yellow-400">ƒê·∫°t:</strong> t·ª´ 50 ƒë·∫øn d∆∞·ªõi 65
                ƒëi·ªÉm
              </li>
              <li>
                <strong class="text-red-400">Ch∆∞a ƒë·∫°t:</strong> d∆∞·ªõi 50 ƒëi·ªÉm
              </li>
            </ul>
          </div>
          <div class="text-center pt-4">
            <button
              onclick="goBackToMain()"
              class="px-6 py-2 rounded-lg shadow-md text-sm btn btn-gray"
            >
              Quay L·∫°i
            </button>
          </div>
        </div>
      </div>

      <!-- Trang T·ªïng K·∫øt Tu·∫ßn & NƒÉm -->
      <div id="monthly-summary-page" class="hidden w-full max-w-6xl mx-auto">
        <div class="card shadow-xl rounded-2xl p-6 md:p-8 space-y-8">
          <h1 class="text-2xl md:text-3xl font-bold text-center">
            T·ªïng K·∫øt Thi ƒêua C√°c Tu·∫ßn
          </h1>
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead id="weekly-summary-header"></thead>
              <tbody id="weekly-summary-body"></tbody>
            </table>
          </div>
          <div
            id="yearly-summary-section"
            class="pt-8 border-t-2 border-dashed border-gray-700"
          >
            <h2 class="text-xl md:text-2xl font-bold text-center mb-6">
              T·ªïng K·∫øt NƒÉm H·ªçc
            </h2>
            <div class="flex items-center justify-center gap-4 mb-6">
              <label class="font-semibold">S·ªë tu·∫ßn h·ªçc th·ª±c t·∫ø (n):</label>
              <div class="flex items-center gap-2">
                <span
                  id="total-weeks-display"
                  class="text-2xl font-bold text-purple-400 w-12 text-center"
                  >0</span
                >
                <button
                  id="increment-n-button"
                  onclick="incrementN()"
                  class="hidden w-10 h-10 bg-gray-700 text-white rounded-full text-xl font-bold hover:bg-gray-600"
                >
                  +
                </button>
              </div>
            </div>
            <div class="text-center">
              <button
                onclick="calculateYearlySummary()"
                class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700"
              >
                T√≠nh T·ªïng K·∫øt NƒÉm
              </button>
            </div>
            <div id="yearly-summary-results" class="mt-6 space-y-4"></div>
          </div>
          <div class="text-center pt-4">
            <button
              onclick="goBackToMain()"
              class="px-6 py-2 rounded-lg shadow-md text-sm btn btn-gray"
            >
              Quay L·∫°i
            </button>
          </div>
        </div>
      </div>

      <!-- Trang S∆° ƒê·ªì L·ªõp -->
      <div id="seating-chart-page" class="hidden w-full max-w-7xl mx-auto">
        <div class="card shadow-xl rounded-2xl p-6 md:p-8 space-y-6">
          <h1 class="text-2xl md:text-3xl font-bold text-center">
            S∆° ƒê·ªì L·ªõp H·ªçc
          </h1>
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-3">
              <div
                class="classroom-feature text-center py-2 rounded-lg font-bold mb-4 shadow-md"
              >
                B·∫¢NG
              </div>
              <div
                class="classroom-feature w-48 h-16 mx-auto rounded-md mb-8 flex items-center justify-center font-semibold shadow-lg"
              >
                B√†n Gi√°o Vi√™n
              </div>
              <div class="flex justify-around gap-8">
                <div
                  id="left-desk-block"
                  class="grid grid-cols-2 gap-y-6 gap-x-4"
                ></div>
                <div
                  id="right-desk-block"
                  class="grid grid-cols-2 gap-y-6 gap-x-4"
                ></div>
              </div>
            </div>
            <div
              class="lg:col-span-1 bg-black bg-opacity-20 p-4 rounded-lg border border-gray-700"
            >
              <h2 class="font-bold text-center mb-4">H·ªçc sinh ch∆∞a x·∫øp ch·ªó</h2>
              <div
                id="unassigned-students-list"
                class="space-y-2 h-96 overflow-y-auto drop-zone p-2"
              ></div>
            </div>
          </div>
          <div class="text-center pt-4 border-t border-gray-700 mt-4">
            <button
              onclick="goBackToMain()"
              class="px-6 py-2 rounded-lg shadow-md text-sm btn btn-gray"
            >
              Quay L·∫°i
            </button>
          </div>
        </div>
      </div>

      <!-- Trang Chi Ti·∫øt Tu·∫ßn C≈© -->
      <div
        id="historical-week-details-page"
        class="hidden w-full max-w-screen-xl mx-auto"
      >
        <div class="card shadow-xl rounded-2xl p-6 md:p-8 space-y-6">
          <h1
            id="historical-week-title"
            class="text-2xl md:text-3xl font-bold text-center"
          >
            Chi Ti·∫øt ƒêi·ªÉm Tu·∫ßn
          </h1>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
              <div
                id="historical-leaderboard-section"
                class="bg-black bg-opacity-20 p-6 rounded-lg border border-gray-700 space-y-4"
              >
                <h2 class="text-xl font-semibold mb-2 text-center">
                  üèÜ B·∫£ng X·∫øp H·∫°ng Tu·∫ßn üèÜ
                </h2>
                <div id="historical-leaderboard-list" class="space-y-3">
                  <!-- Historical Leaderboard content will be generated by JS -->
                </div>
              </div>
            </div>
            <div class="lg:col-span-2">
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead>
                    <tr>
                      <th rowspan="2">STT</th>
                      <th rowspan="2" class="min-w-[120px]">T√™n</th>
                      <th colspan="10">ƒêi·ªÉm c·ªông / tr·ª´ (l·∫ßn)</th>
                      <th rowspan="2">T·ªïng ƒëi·ªÉm</th>
                      <th rowspan="2">X·∫øp lo·∫°i</th>
                    </tr>
                    <tr>
                      <th>ƒêi·ªÉm<br />t·ªët</th>
                      <th>B·ªã ghi<br />SƒêB<br />(-20)</th>
                      <th>N√≥i<br />chuy·ªán<br />(-10)</th>
                      <th>S·ª≠ d·ª•ng<br />ƒëi·ªán tho·∫°i<br />(-50)</th>
                      <th>GV<br />nh·∫Øc nh·ªü<br />(-10)</th>
                      <th>Xem t√†i<br />li·ªáu, KTC<br />(-50)</th>
                      <th>Trang<br />ph·ª•c, KQ<br />(-10)</th>
                      <th>Kh√¥ng<br />h·ªçc b√†i<br />(-20)</th>
                      <th>Ph√°t bi·ªÉu<br />x√¢y d·ª±ng<br />(+10)</th>
                      <th>Tham gia<br />phong tr√†o<br />(+50)</th>
                    </tr>
                  </thead>
                  <tbody id="historical-details-tbody">
                    <!-- Historical data will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="text-center pt-4 border-t border-gray-700 mt-6">
            <button
              onclick="showMonthlySummaryPage()"
              class="px-6 py-2 rounded-lg shadow-md text-sm btn btn-gray"
            >
              Quay L·∫°i B·∫£ng T·ªïng K·∫øt
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- C√°c n√∫t FAB -->
    <div id="fab-container" class="hidden">
      <div
        onclick="showMonthlySummaryPage()"
        class="fab fab-secondary"
        title="Xem t·ªïng k·∫øt tu·∫ßn/nƒÉm"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-8 w-8"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </div>
      <div
        onclick="showSeatingChartPage()"
        class="fab fab-tertiary"
        title="S∆° ƒë·ªì l·ªõp"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-8 w-8"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM10 16v-4m0-4v4m4 4v-4m0-4v4"
          />
        </svg>
      </div>
    </div>

    <!-- C√°c Modals -->
    <div
      id="clear-data-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 h-full w-full flex items-center justify-center z-50"
    >
      <div
        class="card mx-auto p-8 border w-full max-w-md rounded-2xl space-y-6 text-center"
      >
        <h3 class="text-2xl font-bold">X√°c nh·∫≠n X√≥a D·ªØ Li·ªáu</h3>
        <div class="mt-4 px-7 py-3">
          <p class="text-md text-gray-300">
            B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò d·ªØ li·ªáu kh√¥ng?
            <strong class="text-red-400"
              >H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</strong
            >
          </p>
        </div>
        <div class="items-center px-4 py-3 space-x-4">
          <button
            onclick="clearAllData()"
            class="px-6 py-2 btn btn-danger text-base font-medium rounded-md"
          >
            X√°c nh·∫≠n X√≥a
          </button>
          <button
            onclick="closeClearDataModal()"
            class="px-6 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-500"
          >
            H·ªßy
          </button>
        </div>
      </div>
    </div>
    <div
      id="delete-student-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 h-full w-full flex items-center justify-center z-50"
    >
      <div
        class="card mx-auto p-8 border w-full max-w-md rounded-2xl space-y-6 text-center"
      >
        <h3 class="text-2xl font-bold">X√°c nh·∫≠n X√≥a H·ªçc Sinh</h3>
        <div class="mt-4 px-7 py-3">
          <p id="delete-student-confirm-text" class="text-md text-gray-300"></p>
        </div>
        <div class="items-center px-4 py-3 space-x-4">
          <button
            onclick="confirmDeleteStudent()"
            class="px-6 py-2 btn btn-danger text-base font-medium rounded-md"
          >
            X√≥a
          </button>
          <button
            onclick="closeDeleteStudentModal()"
            class="px-6 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-500"
          >
            H·ªßy
          </button>
          <input type="hidden" id="student-id-to-delete" />
        </div>
      </div>
    </div>
    <div
      id="finalize-week-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 h-full w-full flex items-center justify-center z-50"
    >
      <div
        class="card mx-auto p-8 border w-full max-w-md rounded-2xl space-y-6 text-center"
      >
        <h3 class="text-2xl font-bold">X√°c nh·∫≠n Ch·ªët ƒêi·ªÉm Tu·∫ßn</h3>
        <div
          id="finalize-week-summary"
          class="mt-4 text-left p-4 bg-black bg-opacity-20 rounded-lg"
        ></div>
        <p class="text-md text-gray-300 mt-4">
          B·∫°n c√≥ mu·ªën reset ƒëi·ªÉm c·ªßa t·∫•t c·∫£ h·ªçc sinh v·ªÅ 0 ƒë·ªÉ b·∫Øt ƒë·∫ßu tu·∫ßn m·ªõi
          kh√¥ng?
        </p>
        <div class="items-center px-4 py-3 space-x-4">
          <button
            onclick="confirmFinalizeWeek(true)"
            class="px-6 py-2 btn btn-primary text-base font-medium rounded-md"
          >
            L∆∞u v√† Reset
          </button>
          <button
            onclick="confirmFinalizeWeek(false)"
            class="px-6 py-2 bg-gray-700 text-white text-base font-medium rounded-md hover:bg-gray-600"
          >
            Ch·ªâ L∆∞u
          </button>
          <button
            onclick="closeFinalizeWeekModal()"
            class="px-6 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-500"
          >
            H·ªßy
          </button>
        </div>
      </div>
    </div>
    <div
      id="ai-feedback-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 h-full w-full flex items-center justify-center z-50"
    >
      <div
        class="card mx-auto p-8 border w-full max-w-lg rounded-2xl space-y-6 text-center"
      >
        <h3 class="text-2xl font-bold">Nh·∫≠n x√©t Thi ƒêua Tu·∫ßn N√†y ‚ú®</h3>
        <div
          id="ai-feedback-content"
          class="mt-4 px-7 py-3 min-h-[100px] flex items-center justify-center"
        ></div>
        <div class="items-center px-4 py-3">
          <button
            onclick="closeAIFeedbackModal()"
            class="px-6 py-2 btn btn-gray text-base font-medium rounded-md"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
    <div
      id="feedback-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 h-full w-full flex items-center justify-center z-50"
    >
      <div
        class="card mx-auto p-8 border w-full max-w-md rounded-2xl space-y-6"
      >
        <h3 class="text-2xl font-bold text-center">
          G·ª≠i Ph·∫£n H·ªìi T·ªõi Gi√°o Vi√™n
        </h3>
        <div class="space-y-4">
          <div>
            <label
              for="feedback-modal-name"
              class="block text-sm font-medium text-gray-300"
              >H·ªç v√† T√™n</label
            >
            <input
              type="text"
              id="feedback-modal-name"
              class="input-field mt-1 block w-full px-3 py-2 rounded-md shadow-sm"
              placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n"
            />
          </div>
          <div>
            <label
              for="feedback-modal-content"
              class="block text-sm font-medium text-gray-300"
              >N·ªôi dung</label
            >
            <textarea
              id="feedback-modal-content"
              class="input-field w-full h-24 p-2 rounded-md mt-1"
              placeholder="Nh·∫≠p √Ω ki·∫øn c·ªßa b·∫°n..."
            ></textarea>
          </div>
        </div>
        <p
          id="feedback-modal-status"
          class="text-sm text-green-400 text-center hidden"
        ></p>
        <div class="flex justify-end gap-4">
          <button
            onclick="closeFeedbackModal()"
            class="px-6 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-500"
          >
            H·ªßy
          </button>
          <button
            onclick="sendFeedback()"
            class="px-6 py-2 btn btn-secondary text-base font-medium rounded-md"
          >
            G·ª≠i
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- SCRIPT ƒê·∫¶Y ƒê·ª¶ ---
      const predefinedUsers = {
        "to1@gmail.com": { role: "T·ªï 1", groupId: 1 },
        "to2@gmail.com": { role: "T·ªï 2", groupId: 2 },
        "to3@gmail.com": { role: "T·ªï 3", groupId: 3 },
        "to4@gmail.com": { role: "T·ªï 4", groupId: 4 },
        "admin@check.com": { role: "ADMIN", groupId: null },
        "view@check.com": { role: "VIEWER", groupId: null },
      };
      let students = [];
      let detailedScores = {};
      let weeklySummaries = { weeks: [], totalWeeks: 0 };
      let classInfo = {};
      let unsubscribeStudents,
        unsubscribeScores,
        unsubscribeWeekly,
        unsubscribeClassInfo,
        unsubscribeFeedback;
      let currentUserRole = null;
      let currentUserGroupId = null;
      let targetGroupIdForScoring = null;
      let currentScoringGroupId = null;

      const studentsDocRef = () => db.collection("classes").doc("mainClass");
      const weeklyScoresDocRef = () =>
        db.collection("classes").doc("currentWeekDetailedScores");
      const weeklySummariesDocRef = () =>
        db.collection("classes").doc("weeklySummaries");
      const classInfoDocRef = () => db.collection("classes").doc("classInfo");
      const feedbackCollectionRef = () => db.collection("feedback");

      const loginPage = document.getElementById("login-page"),
        mainPage = document.getElementById("main-page"),
        individualScoringPage = document.getElementById(
          "individual-scoring-page"
        ),
        monthlySummaryPage = document.getElementById("monthly-summary-page"),
        seatingChartPage = document.getElementById("seating-chart-page"),
        historicalWeekDetailsPage = document.getElementById(
          "historical-week-details-page"
        ),
        fabContainer = document.getElementById("fab-container"),
        loginError = document.getElementById("login-error"),
        userInfo = document.getElementById("user-info"),
        clearDataButton = document.getElementById("clear-data-button"),
        finalizeWeekButton = document.getElementById("finalize-week-button"),
        incrementNButton = document.getElementById("increment-n-button"),
        aiFeedbackModal = document.getElementById("ai-feedback-modal"),
        aiFeedbackContent = document.getElementById("ai-feedback-content"),
        unassignedStudentsList = document.getElementById(
          "unassigned-students-list"
        ),
        loginBackground = document.getElementById("login-background"),
        appContainer = document.getElementById("app-container");

      auth.onAuthStateChanged((user) => {
        const allPages = [
          mainPage,
          individualScoringPage,
          monthlySummaryPage,
          seatingChartPage,
          historicalWeekDetailsPage,
        ];
        if (user) {
          const userData = predefinedUsers[user.email.toLowerCase()];
          if (userData) {
            currentUserRole = userData.role;
            currentUserGroupId = userData.groupId;
            userInfo.innerHTML = `<strong>${user.email}</strong> [${currentUserRole}]`;
            if (currentUserRole === "ADMIN") {
              targetGroupIdForScoring = "ALL";
            } else if (currentUserRole === "VIEWER") {
              targetGroupIdForScoring = null;
            } else if (currentUserGroupId === 1) {
              targetGroupIdForScoring = 3; // 1 ch·∫•m 3
            } else if (currentUserGroupId === 2) {
              targetGroupIdForScoring = 4; // 2 ch·∫•m 4
            } else if (currentUserGroupId === 3) {
              targetGroupIdForScoring = 1; // 3 ch·∫•m 1
            } else if (currentUserGroupId === 4) {
              targetGroupIdForScoring = 2; // 4 ch·∫•m 2
            }
          }
          const isAdmin = currentUserRole === "ADMIN";
          const isViewer = currentUserRole === "VIEWER";

          document
            .getElementById("admin-feedback-viewer")
            .classList.toggle("hidden", !isAdmin);
          document
            .getElementById("viewer-actions-section")
            .classList.toggle("hidden", !isViewer);
          document
            .getElementById("functions-section")
            .classList.toggle("hidden", isViewer);
          document
            .getElementById("add-student-section")
            .classList.toggle("hidden", !isAdmin);

          clearDataButton.classList.toggle("hidden", !isAdmin);
          finalizeWeekButton.classList.toggle("hidden", !isAdmin);

          appContainer.classList.remove("items-center", "justify-center");
          loginPage.classList.add("hidden");
          loginBackground.classList.add("hidden");
          mainPage.classList.remove("hidden");
          fabContainer.classList.remove("hidden");

          if (isAdmin) {
            listenForFeedback();
          }

          listenForDataChanges();
          renderScoringButtons();
        } else {
          if (unsubscribeStudents) unsubscribeStudents();
          if (unsubscribeScores) unsubscribeScores();
          if (unsubscribeWeekly) unsubscribeWeekly();
          if (unsubscribeClassInfo) unsubscribeClassInfo();
          if (unsubscribeFeedback) unsubscribeFeedback();

          currentUserRole = null;
          currentUserGroupId = null;
          allPages.forEach((page) => page.classList.add("hidden"));
          fabContainer.classList.add("hidden");

          appContainer.classList.add("items-center", "justify-center");
          loginPage.classList.remove("hidden");
          loginBackground.classList.remove("hidden");
        }
      });

      async function handleLogin() {
        const email = document.getElementById("email").value.trim(),
          password = document.getElementById("password").value;
        const loginErrorEl = document.getElementById("login-error");
        loginErrorEl.classList.add("hidden");
        if (!email || !password) {
          loginErrorEl.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.";
          loginErrorEl.classList.remove("hidden");
          return;
        }
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
          console.error("L·ªói ƒëƒÉng nh·∫≠p:", error.code);
          if (
            [
              "auth/invalid-credential",
              "auth/user-not-found",
              "auth/wrong-password",
              "auth/invalid-login-credentials",
              "auth/invalid-email",
            ].includes(error.code)
          ) {
            loginErrorEl.textContent = "L·ªói: Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.";
          } else {
            loginErrorEl.textContent =
              "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh. Vui l√≤ng th·ª≠ l·∫°i.";
          }
          loginErrorEl.classList.remove("hidden");
        }
      }

      const handleLogout = async () => {
        await auth.signOut();
      };

      function showPage(pageToShow) {
        [
          mainPage,
          individualScoringPage,
          monthlySummaryPage,
          seatingChartPage,
          historicalWeekDetailsPage,
        ].forEach((p) => p.classList.add("hidden"));
        pageToShow.classList.remove("hidden");
        fabContainer.classList.toggle("hidden", pageToShow !== mainPage);
      }

      const goBackToMain = () => showPage(mainPage);
      const showMonthlySummaryPage = () => {
        renderMonthlySummaryPage();
        showPage(monthlySummaryPage);
      };
      const showSeatingChartPage = () => {
        renderSeatingChart();
        showPage(seatingChartPage);
      };

      function listenForDataChanges() {
        if (unsubscribeStudents) unsubscribeStudents();
        unsubscribeStudents = studentsDocRef().onSnapshot((doc) => {
          students = doc.exists ? doc.data().students || [] : [];
          renderStudentList();
          renderLeaderboard();
          if (!seatingChartPage.classList.contains("hidden"))
            renderSeatingChart();
        });
        if (unsubscribeScores) unsubscribeScores();
        unsubscribeScores = weeklyScoresDocRef().onSnapshot((doc) => {
          detailedScores = doc.exists ? doc.data() || {} : {};
          renderStudentList(); // Update scores on main page
          renderLeaderboard();
          if (!individualScoringPage.classList.contains("hidden"))
            renderIndividualScoringPage();
        });
        if (unsubscribeWeekly) unsubscribeWeekly();
        unsubscribeWeekly = weeklySummariesDocRef().onSnapshot((doc) => {
          weeklySummaries = doc.exists
            ? doc.data() || { weeks: [], totalWeeks: 0 }
            : { weeks: [], totalWeeks: 0 };
          if (!monthlySummaryPage.classList.contains("hidden"))
            renderMonthlySummaryPage();
        });
        if (unsubscribeClassInfo) unsubscribeClassInfo();
        unsubscribeClassInfo = classInfoDocRef().onSnapshot((doc) => {
          classInfo = doc.exists
            ? doc.data()
            : {
                subtitle:
                  "L·ªõp 12A1 - NƒÉm h·ªçc 2025-2026 ¬∑ Tu·∫ßn ..... (T·ª´ ng√†y ..../.../.... ƒë·∫øn ng√†y ..../.../....)",
              };
          const subtitleEl = document.getElementById("scoring-page-subtitle");
          if (subtitleEl) {
            subtitleEl.value = classInfo.subtitle || "";
          }
        });
      }

      const scoreColumns = [
        "diemtot",
        "ghisodb",
        "noichuyen",
        "sudungdienthoai",
        "gvnhacnho",
        "xemtailieu",
        "trangphuc",
        "khonghocbai",
        "phatbieu",
        "thamgiaphongtrao",
      ];
      const pointValues = {
        diemtot: 1,
        ghisodb: -20,
        noichuyen: -10,
        sudungdienthoai: -50,
        gvnhacnho: -10,
        xemtailieu: -50,
        trangphuc: -10,
        khonghocbai: -20,
        phatbieu: 10,
        thamgiaphongtrao: 50,
      };
      const STARTING_SCORE = 50;

      function getXepLoai(score) {
        if (score >= 90)
          return '<span class="font-bold text-green-400">T·ªët</span>';
        if (score >= 65)
          return '<span class="font-bold text-blue-400">Kh√°</span>';
        if (score >= 50)
          return '<span class="font-bold text-yellow-400">ƒê·∫°t</span>';
        return '<span class="font-bold text-red-400">Ch∆∞a ƒë·∫°t</span>';
      }

      function renderLeaderboard() {
        const leaderboardList = document.getElementById("leaderboard-list");
        if (!leaderboardList) return;

        const allStudentsWithScores = students.map((student) => {
          let totalScore = STARTING_SCORE;
          const studentScores = detailedScores[student.id] || {};
          scoreColumns.forEach((col) => {
            totalScore += (studentScores[col] || 0) * (pointValues[col] || 0);
          });
          return { ...student, totalScore };
        });

        const sortedStudents = allStudentsWithScores.sort(
          (a, b) => b.totalScore - a.totalScore
        );
        const top10 = sortedStudents.slice(0, 10);

        leaderboardList.innerHTML = "";
        if (top10.length === 0) {
          leaderboardList.innerHTML =
            '<p class="text-center text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm.</p>';
          return;
        }

        top10.forEach((student, index) => {
          let medal = "";
          if (index === 0) medal = "ü•á";
          else if (index === 1) medal = "ü•à";
          else if (index === 2) medal = "ü•â";
          else
            medal = `<span class="font-normal text-gray-400 w-6 text-right">${
              index + 1
            }.</span>`;

          const studentElement = document.createElement("div");
          studentElement.className =
            "flex items-center justify-between p-2 rounded-md bg-gray-900 bg-opacity-50";
          studentElement.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold w-6 text-center">${medal}</span>
                        <div>
                            <p class="font-semibold text-sm text-white">${student.name}</p>
                            <p class="text-xs text-gray-400">T·ªï ${student.group}</p>
                        </div>
                    </div>
                    <span class="font-bold text-lg text-yellow-400">${student.totalScore}</span>
                `;
          leaderboardList.appendChild(studentElement);
        });
      }

      function renderStudentList() {
        for (let i = 1; i <= 4; i++) {
          const groupZone = document.getElementById(`group-${i}`);
          if (!groupZone) continue;
          groupZone.innerHTML = "";
          students
            .filter((s) => s.group === i)
            .forEach((student) => {
              const studentCard = document.createElement("div");
              studentCard.id = student.id;
              studentCard.className = "student-card text-center";

              let totalScore = STARTING_SCORE;
              const studentScores = detailedScores[student.id] || {};
              scoreColumns.forEach((col) => {
                totalScore +=
                  (studentScores[col] || 0) * (pointValues[col] || 0);
              });

              studentCard.innerHTML = `<div class="student-id">${student.id}</div><div class="student-name text-xs truncate">${student.name}</div><div class="student-score">${totalScore}</div>`;
              groupZone.appendChild(studentCard);
            });
        }
      }

      function renderScoringButtons() {
        const isViewer = currentUserRole === "VIEWER";
        for (let i = 1; i <= 4; i++) {
          const btn = document.getElementById(`score-group-${i}-btn`);
          if (!btn) continue;

          // Viewer can view any group's score sheet
          if (isViewer) {
            btn.classList.remove("hidden");
            btn.textContent = `Xem ƒêi·ªÉm T·ªï ${i}`; // Change text for viewer
          } else {
            let canScore = false;
            if (targetGroupIdForScoring === "ALL") canScore = true;
            if (targetGroupIdForScoring === i) canScore = true;
            btn.classList.toggle("hidden", !canScore);
            btn.textContent = `Ch·∫•m ƒêi·ªÉm T·ªï ${i}`; // Original text
          }
        }
      }

      function goToScoringPage(groupId) {
        currentScoringGroupId = groupId;
        const titleEl = document.getElementById("scoring-page-title");
        const subtitleInput = document.getElementById("scoring-page-subtitle");
        if (titleEl) titleEl.textContent = `S·ªî THEO D√ïI THI ƒêUA T·ªî ${groupId}`;

        if (subtitleInput) {
          subtitleInput.disabled = currentUserRole !== "ADMIN";
        }

        renderIndividualScoringPage();
        showPage(individualScoringPage);
      }

      function renderIndividualScoringPage() {
        const tbody = document.getElementById("individual-scoring-tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        const isViewer = currentUserRole === "VIEWER";
        const studentsToDisplay =
          currentScoringGroupId === "ALL" || isViewer
            ? students
            : students.filter((s) => s.group === currentScoringGroupId);

        studentsToDisplay.forEach((student, index) => {
          const row = document.createElement("tr");
          let rowHTML = `<td>${
            index + 1
          }</td><td class="text-left font-semibold">${student.name}</td>`;

          let totalScore = STARTING_SCORE;
          const studentScores = detailedScores[student.id] || {};

          scoreColumns.forEach((col) => {
            const value = studentScores[col] || "";
            rowHTML += `<td><input type="number" class="table-input" value="${value}" oninput="handleIndividualScoreChange(this, '${
              student.id
            }', '${col}')" min="0" ${isViewer ? "disabled" : ""}></td>`;
            if (value) totalScore += Number(value) * (pointValues[col] || 0);
          });

          rowHTML += `<td id="total-score-${student.id}" class="font-bold">${totalScore}</td>`;
          rowHTML += `<td id="xeploai-${student.id}">${getXepLoai(
            totalScore
          )}</td>`;

          row.innerHTML = rowHTML;
          tbody.appendChild(row);
        });
        calculateColumnTotals();
      }

      async function handleSubtitleChange(input) {
        if (currentUserRole !== "ADMIN") return;
        const newSubtitle = input.value;
        await classInfoDocRef().set({ subtitle: newSubtitle }, { merge: true });
      }

      async function handleIndividualScoreChange(input, studentId, column) {
        const value = Number(input.value);
        if (!detailedScores[studentId]) detailedScores[studentId] = {};

        if (value > 0) {
          detailedScores[studentId][column] = value;
        } else {
          delete detailedScores[studentId][column];
        }

        let totalScore = STARTING_SCORE;
        scoreColumns.forEach((col) => {
          totalScore +=
            (detailedScores[studentId][col] || 0) * (pointValues[col] || 0);
        });

        document.getElementById(`total-score-${studentId}`).textContent =
          totalScore;
        document.getElementById(`xeploai-${studentId}`).innerHTML =
          getXepLoai(totalScore);

        calculateColumnTotals();

        await weeklyScoresDocRef().set(detailedScores, { merge: true });
      }

      function calculateColumnTotals() {
        let finalTotal = 0;
        const groupStudents = students.filter(
          (s) => s.group === currentScoringGroupId
        );

        scoreColumns.forEach((col) => {
          let colTotal = 0;
          groupStudents.forEach(
            (student) => (colTotal += detailedScores[student.id]?.[col] || 0)
          );
          const totalColEl = document.getElementById(`total-col-${col}`);
          if (totalColEl) totalColEl.textContent = colTotal;
        });

        groupStudents.forEach((student) => {
          let studentTotal = STARTING_SCORE;
          const studentScores = detailedScores[student.id] || {};
          scoreColumns.forEach((col) => {
            studentTotal += (studentScores[col] || 0) * (pointValues[col] || 0);
          });
          finalTotal += studentTotal;
        });

        const finalTotalEl = document.getElementById("total-final");
        if (finalTotalEl) finalTotalEl.textContent = finalTotal;
      }

      function renderMonthlySummaryPage() {
        const header = document.getElementById("weekly-summary-header");
        const body = document.getElementById("weekly-summary-body");
        if (!header || !body) return;
        header.innerHTML = "";
        body.innerHTML = "";
        if (!weeklySummaries.weeks || weeklySummaries.weeks.length === 0) {
          body.innerHTML =
            '<tr><td colspan="6" class="text-center text-gray-400 p-4">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>';
          return;
        }
        let headerHTML = "<tr><th>Tu·∫ßn</th>";
        for (let i = 1; i <= 4; i++) {
          headerHTML += `<th>T·ªï ${i}</th>`;
        }
        headerHTML += "<th>Thao t√°c</th></tr>";
        header.innerHTML = headerHTML;

        weeklySummaries.weeks.forEach((week) => {
          const row = document.createElement("tr");
          let rowHTML = `<td class="font-bold">Tu·∫ßn ${week.weekNumber}</td>`;
          for (let i = 1; i <= 4; i++) {
            rowHTML += `<td>${week.scores[i] || 0}</td>`;
          }
          rowHTML += `<td><button onclick="showHistoricalWeekDetails(${week.weekNumber})" class="text-xs px-2 py-1 btn btn-gray rounded-md">Xem Chi Ti·∫øt</button></td>`;
          row.innerHTML = rowHTML;
          body.appendChild(row);
        });
        document.getElementById("total-weeks-display").textContent =
          weeklySummaries.totalWeeks || 0;
        incrementNButton.classList.toggle(
          "hidden",
          currentUserRole !== "ADMIN"
        );
      }

      const openClearDataModal = () =>
        document.getElementById("clear-data-modal").classList.remove("hidden");
      const closeClearDataModal = () =>
        document.getElementById("clear-data-modal").classList.add("hidden");
      async function clearAllData() {
        if (
          confirm(
            "X√°c nh·∫≠n l·∫ßn cu·ªëi: X√≥a TO√ÄN B·ªò D·ªÆ LI·ªÜU? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c."
          )
        ) {
          await studentsDocRef().set({ students: [] });
          await weeklyScoresDocRef().set({});
          await weeklySummariesDocRef().set({ weeks: [], totalWeeks: 0 });
          alert("ƒê√£ x√≥a s·∫°ch d·ªØ li·ªáu.");
          closeClearDataModal();
        }
      }

      const openFinalizeWeekModal = () => {
        const summaryDiv = document.getElementById("finalize-week-summary");
        summaryDiv.innerHTML =
          '<p class="font-bold mb-2">ƒêi·ªÉm t·ªïng k·∫øt tu·∫ßn:</p>';
        let groupScores = { 1: 0, 2: 0, 3: 0, 4: 0 };
        for (let i = 1; i <= 4; i++) {
          let groupTotal = 0;
          const groupStudents = students.filter((s) => s.group === i);
          groupStudents.forEach((student) => {
            let studentTotal = STARTING_SCORE;
            scoreColumns.forEach(
              (col) =>
                (studentTotal +=
                  (detailedScores[student.id]?.[col] || 0) *
                  (pointValues[col] || 0))
            );
            groupTotal += studentTotal;
          });
          groupScores[i] = groupTotal;
          summaryDiv.innerHTML += `<p><strong>T·ªï ${i}:</strong> ${groupScores[i]} ƒëi·ªÉm</p>`;
        }
        document
          .getElementById("finalize-week-modal")
          .classList.remove("hidden");
      };
      const closeFinalizeWeekModal = () =>
        document.getElementById("finalize-week-modal").classList.add("hidden");

      async function confirmFinalizeWeek(shouldReset) {
        let groupScores = { 1: 0, 2: 0, 3: 0, 4: 0 };
        const individualStudentScores = {};
        const historicalDetailedScores = JSON.parse(
          JSON.stringify(detailedScores)
        );
        const historicalStudents = JSON.parse(JSON.stringify(students));

        for (let i = 1; i <= 4; i++) {
          let groupTotal = 0;
          const groupStudents = historicalStudents.filter((s) => s.group === i);
          groupStudents.forEach((student) => {
            let studentTotal = STARTING_SCORE;
            const studentDetailedScores =
              historicalDetailedScores[student.id] || {};
            scoreColumns.forEach(
              (col) =>
                (studentTotal +=
                  (studentDetailedScores[col] || 0) * (pointValues[col] || 0))
            );
            individualStudentScores[student.id] = studentTotal;
            groupTotal += studentTotal;
          });
          groupScores[i] = groupTotal;
        }

        const newWeekData = {
          weekNumber: (weeklySummaries.weeks?.length || 0) + 1,
          timestamp: new Date().toISOString(),
          scores: groupScores,
          studentScores: individualStudentScores,
          detailedScores: historicalDetailedScores,
          students: historicalStudents,
        };

        const updatedWeeks = [...(weeklySummaries.weeks || []), newWeekData];
        await weeklySummariesDocRef().set(
          { ...weeklySummaries, weeks: updatedWeeks },
          { merge: true }
        );

        if (shouldReset) {
          await weeklyScoresDocRef().set({});
          alert(
            "ƒê√£ l∆∞u ƒëi·ªÉm tu·∫ßn (bao g·ªìm ƒëi·ªÉm c√° nh√¢n) v√† reset ƒëi·ªÉm cho tu·∫ßn m·ªõi."
          );
        } else {
          alert("ƒê√£ l∆∞u ƒëi·ªÉm tu·∫ßn (bao g·ªìm ƒëi·ªÉm c√° nh√¢n).");
        }
        closeFinalizeWeekModal();
      }

      async function incrementN() {
        const newN = (weeklySummaries.totalWeeks || 0) + 1;
        await weeklySummariesDocRef().set(
          { totalWeeks: newN },
          { merge: true }
        );
      }

      function calculateYearlySummary() {
        const resultsDiv = document.getElementById("yearly-summary-results");
        resultsDiv.innerHTML = "";
        const n = weeklySummaries.totalWeeks || 0;
        if (n === 0) {
          resultsDiv.innerHTML =
            '<p class="text-center text-red-400">Vui l√≤ng thi·∫øt l·∫≠p s·ªë tu·∫ßn h·ªçc (n).</p>';
          return;
        }
        if (!weeklySummaries.weeks || weeklySummaries.weeks.length === 0) {
          resultsDiv.innerHTML =
            '<p class="text-center text-red-400">Kh√¥ng c√≥ d·ªØ li·ªáu tu·∫ßn.</p>';
          return;
        }
        let yearlyScores = { 1: 0, 2: 0, 3: 0, 4: 0 };
        weeklySummaries.weeks.forEach((week) => {
          for (let i = 1; i <= 4; i++) yearlyScores[i] += week.scores[i] || 0;
        });
        const sortedYearly = Object.entries(yearlyScores).sort(
          (a, b) => b[1] - a[1]
        );
        let resultHTML = `<h4 class="font-bold text-center">K·∫øt qu·∫£ x·∫øp h·∫°ng nƒÉm:</h4>`;
        sortedYearly.forEach(([groupId, score], index) => {
          resultHTML += `<div class="p-4 border rounded-lg bg-green-900 bg-opacity-30 border-green-500"><div class="flex justify-between items-center"><span class="font-bold text-lg">${
            index + 1
          }. T·ªï ${groupId}</span><span class="font-bold text-xl text-green-400"}">${score} ƒëi·ªÉm</span></div></div>`;
        });
        resultsDiv.innerHTML = resultHTML;
      }

      function showHistoricalWeekDetails(weekNumber) {
        const weekData = weeklySummaries.weeks.find(
          (w) => w.weekNumber === weekNumber
        );
        if (weekData) {
          renderHistoricalWeekPage(weekData);
          showPage(historicalWeekDetailsPage);
        } else {
          alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho tu·∫ßn ƒë√£ ch·ªçn.");
        }
      }

      function renderHistoricalWeekPage(weekData) {
        const titleEl = document.getElementById("historical-week-title");
        if (titleEl)
          titleEl.textContent = `Chi Ti·∫øt ƒêi·ªÉm Tu·∫ßn ${weekData.weekNumber}`;

        renderHistoricalLeaderboard(weekData);
        renderHistoricalWeekDetailsTable(weekData);
      }

      function renderHistoricalLeaderboard(weekData) {
        const leaderboardList = document.getElementById(
          "historical-leaderboard-list"
        );
        if (!leaderboardList) return;

        const studentsForWeek = weekData.students || [];
        const studentScoresForWeek = weekData.studentScores || {};

        const allStudentsWithScores = studentsForWeek.map((student) => ({
          ...student,
          totalScore: studentScoresForWeek[student.id] || STARTING_SCORE,
        }));

        const sortedStudents = allStudentsWithScores.sort(
          (a, b) => b.totalScore - a.totalScore
        );
        const top10 = sortedStudents.slice(0, 10);

        leaderboardList.innerHTML = "";
        if (top10.length === 0) {
          leaderboardList.innerHTML =
            '<p class="text-center text-gray-400">Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm.</p>';
          return;
        }

        top10.forEach((student, index) => {
          let medal = "";
          if (index === 0) medal = "ü•á";
          else if (index === 1) medal = "ü•à";
          else if (index === 2) medal = "ü•â";
          else
            medal = `<span class="font-normal text-gray-400 w-6 text-right">${
              index + 1
            }.</span>`;

          const studentElement = document.createElement("div");
          studentElement.className =
            "flex items-center justify-between p-2 rounded-md bg-gray-900 bg-opacity-50";
          studentElement.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold w-6 text-center">${medal}</span>
                        <div>
                            <p class="font-semibold text-sm text-white">${student.name}</p>
                            <p class="text-xs text-gray-400">T·ªï ${student.group}</p>
                        </div>
                    </div>
                    <span class="font-bold text-lg text-yellow-400">${student.totalScore}</span>
                `;
          leaderboardList.appendChild(studentElement);
        });
      }

      function renderHistoricalWeekDetailsTable(weekData) {
        const tbody = document.getElementById("historical-details-tbody");
        if (!tbody) return;

        tbody.innerHTML = "";

        const weekStudents = weekData.students || [];
        const weekDetailedScores = weekData.detailedScores || {};
        const weekStudentTotals = weekData.studentScores || {};
        const isAdmin = currentUserRole === "ADMIN";

        for (let i = 1; i <= 4; i++) {
          const groupStudents = weekStudents.filter((s) => s.group === i);
          if (groupStudents.length > 0) {
            const groupHeaderRow = document.createElement("tr");
            groupHeaderRow.innerHTML = `<td colspan="14" class="text-left font-bold bg-gray-800 text-purple-300 p-2">T·ªî ${i}</td>`;
            tbody.appendChild(groupHeaderRow);

            groupStudents.forEach((student, index) => {
              const row = document.createElement("tr");
              let rowHTML = `<td>${
                index + 1
              }</td><td class="text-left font-semibold">${student.name}</td>`;

              const studentScoresForWeek = weekDetailedScores[student.id] || {};

              scoreColumns.forEach((col) => {
                const value = studentScoresForWeek[col] || "";
                rowHTML += `<td>${value}</td>`;
              });

              const totalScore =
                weekStudentTotals[student.id] || STARTING_SCORE;

              if (isAdmin) {
                rowHTML += `<td class="font-bold"><input type="number" class="table-input w-16" value="${totalScore}" onchange="handleHistoricalScoreChange(this, '${student.id}', ${weekData.weekNumber})"></td>`;
              } else {
                rowHTML += `<td class="font-bold">${totalScore}</td>`;
              }

              rowHTML += `<td id="historical-xeploai-${
                student.id
              }">${getXepLoai(totalScore)}</td>`;

              row.innerHTML = rowHTML;
              tbody.appendChild(row);
            });
          }
        }
      }

      async function handleHistoricalScoreChange(input, studentId, weekNumber) {
        const newScore = Number(input.value);
        const weekIndex = weeklySummaries.weeks.findIndex(
          (w) => w.weekNumber === weekNumber
        );
        if (weekIndex === -1) return;

        // Update student's total score for that week
        weeklySummaries.weeks[weekIndex].studentScores[studentId] = newScore;

        // Recalculate the group's total score for that week
        const student = weeklySummaries.weeks[weekIndex].students.find(
          (s) => s.id === studentId
        );
        if (student) {
          const groupId = student.group;
          let newGroupTotal = 0;
          const groupStudents = weeklySummaries.weeks[
            weekIndex
          ].students.filter((s) => s.group === groupId);
          groupStudents.forEach((s) => {
            newGroupTotal +=
              weeklySummaries.weeks[weekIndex].studentScores[s.id] || 0;
          });
          weeklySummaries.weeks[weekIndex].scores[groupId] = newGroupTotal;
        }

        // Save the entire updated summary back to Firestore
        await weeklySummariesDocRef().set(weeklySummaries);

        // Re-render the table to reflect changes (like updated xep loai)
        renderHistoricalWeekPage(weeklySummaries.weeks[weekIndex]);
      }

      const openAIFeedbackModal = () =>
        document.getElementById("ai-feedback-modal").classList.remove("hidden");
      const closeAIFeedbackModal = () =>
        document.getElementById("ai-feedback-modal").classList.add("hidden");
      async function getAIFeedback() {
        openAIFeedbackModal();
        aiFeedbackContent.innerHTML =
          '<div class="spinner mx-auto"></div><p class="mt-2 text-gray-400">AI ƒëang ph√¢n t√≠ch...</p>';
        let groupScores = { 1: 0, 2: 0, 3: 0, 4: 0 };
        for (let i = 1; i <= 4; i++) {
          let groupTotal = 0;
          students
            .filter((s) => s.group === i)
            .forEach((student) => {
              let studentTotal = STARTING_SCORE;
              scoreColumns.forEach(
                (col) =>
                  (studentTotal +=
                    (detailedScores[student.id]?.[col] || 0) *
                    (pointValues[col] || 0))
              );
              groupTotal += studentTotal;
            });
          groupScores[i] = groupTotal;
        }
        const scoresText = `T·ªï 1: ${groupScores[1]}, T·ªï 2: ${groupScores[2]}, T·ªï 3: ${groupScores[3]}, T·ªï 4: ${groupScores[4]}.`;
        const systemPrompt =
          "B·∫°n l√† m·ªôt c·ªë v·∫•n h·ªçc t·∫≠p vui v·∫ª, t√≠ch c·ª±c. H√£y nh·∫≠n x√©t ng·∫Øn g·ªçn (3-5 c√¢u) v·ªÅ k·∫øt qu·∫£ thi ƒëua. Gi·ªØ gi·ªçng vƒÉn kh√≠ch l·ªá, t·∫≠p trung v√†o s·ª± c·ªë g·∫Øng. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.";
        const userQuery = `ƒêi·ªÉm thi ƒëua tu·∫ßn n√†y: ${scoresText}. Vi·∫øt nh·∫≠n x√©t ng·∫Øn g·ªçn, t√≠ch c·ª±c, ch√∫c m·ª´ng t·ªï cao nh·∫•t v√† ƒë·ªông vi√™n c√°c t·ªï kh√°c.`;
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: userQuery }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
            }),
          });
          if (!response.ok)
            throw new Error(`API call failed: ${response.status}`);
          const result = await response.json();
          const feedbackText =
            result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (feedbackText)
            aiFeedbackContent.innerHTML = `<p class="text-gray-300 text-left whitespace-pre-wrap">${feedbackText}</p>`;
          else throw new Error("No content from AI.");
        } catch (error) {
          console.error("Gemini API Error:", error);
          aiFeedbackContent.innerHTML = `<p class="text-red-400">L·ªói khi t·∫°o nh·∫≠n x√©t. Vui l√≤ng th·ª≠ l·∫°i.</p>`;
        }
      }

      const openFeedbackModal = () =>
        document.getElementById("feedback-modal").classList.remove("hidden");
      const closeFeedbackModal = () =>
        document.getElementById("feedback-modal").classList.add("hidden");

      async function sendFeedback() {
        const nameInput = document.getElementById("feedback-modal-name");
        const contentTextarea = document.getElementById(
          "feedback-modal-content"
        );
        const statusEl = document.getElementById("feedback-modal-status");

        const name = nameInput.value.trim();
        const message = contentTextarea.value.trim();

        if (!name || !message) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç v√† T√™n v√† N·ªôi dung ph·∫£n h·ªìi.");
          return;
        }

        try {
          await feedbackCollectionRef().add({
            name: name,
            message: message,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            isRead: false,
          });
          nameInput.value = "";
          contentTextarea.value = "";
          statusEl.textContent = "G·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng!";
          statusEl.classList.remove("hidden");
          setTimeout(() => {
            statusEl.classList.add("hidden");
            closeFeedbackModal();
          }, 2000);
        } catch (error) {
          console.error("Error sending feedback: ", error);
          statusEl.textContent = "L·ªói! Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi.";
          statusEl.classList.remove("hidden", "text-green-400");
          statusEl.classList.add("text-red-400");
        }
      }

      async function addStudent() {
        const nameInput = document.getElementById("new-student-name");
        const groupInput = document.getElementById("new-student-group");

        const name = nameInput.value.trim();
        const group = parseInt(groupInput.value, 10);

        if (!name) {
          alert("Vui l√≤ng nh·∫≠p t√™n h·ªçc sinh.");
          return;
        }
        if (isNaN(group) || group < 1 || group > 4) {
          alert("Vui l√≤ng nh·∫≠p s·ªë t·ªï h·ª£p l·ªá (1-4).");
          return;
        }

        // Generate a new unique ID
        let maxId = 0;
        students.forEach((s) => {
          const idNum = parseInt(s.id.replace("HS", ""), 10);
          if (!isNaN(idNum) && idNum > maxId) {
            maxId = idNum;
          }
        });
        const newId = `HS${maxId + 1}`;

        const newStudent = {
          id: newId,
          name: name,
          group: group,
        };

        const updatedStudents = [...students, newStudent];

        try {
          await studentsDocRef().set({ students: updatedStudents });
          alert(`ƒê√£ th√™m th√†nh c√¥ng h·ªçc sinh "${name}" v√†o t·ªï ${group}.`);
          nameInput.value = "";
          groupInput.value = "";
        } catch (error) {
          console.error("L·ªói khi th√™m h·ªçc sinh: ", error);
          alert("ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      }

      function listenForFeedback() {
        if (unsubscribeFeedback) unsubscribeFeedback();
        unsubscribeFeedback = feedbackCollectionRef()
          .orderBy("timestamp", "desc")
          .onSnapshot((snapshot) => {
            const feedbackItems = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            renderFeedback(feedbackItems);
          });
      }

      function renderFeedback(feedbackItems) {
        const listEl = document.getElementById("feedback-list");
        if (!listEl) return;
        listEl.innerHTML = "";

        if (feedbackItems.length === 0) {
          listEl.innerHTML =
            '<p class="text-center text-gray-400 text-sm">Kh√¥ng c√≥ ph·∫£n h·ªìi n√†o.</p>';
          return;
        }

        feedbackItems.forEach((item) => {
          const itemEl = document.createElement("div");
          itemEl.className = `feedback-item ${!item.isRead ? "unread" : ""}`;

          const date = item.timestamp
            ? item.timestamp.toDate().toLocaleString("vi-VN")
            : "ƒêang g·ª≠i...";

          itemEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="feedback-meta">T·ª´: <strong class="text-purple-300">${
                              item.name || "Kh√¥ng r√µ"
                            }</strong></p>
                            <p class="feedback-meta">L√∫c: ${date}</p>
                        </div>
                        <span class="delete-feedback-btn" onclick="deleteFeedback(event, '${
                          item.id
                        }')" title="X√≥a ph·∫£n h·ªìi">&times;</span>
                    </div>
                    <p class="feedback-content">${item.message}</p>
                `;
          if (!item.isRead) {
            itemEl.style.cursor = "pointer";
            itemEl.setAttribute("onclick", `markFeedbackAsRead('${item.id}')`);
          }
          listEl.appendChild(itemEl);
        });
      }

      async function markFeedbackAsRead(id) {
        try {
          await feedbackCollectionRef().doc(id).update({ isRead: true });
        } catch (error) {
          console.error("Error marking feedback as read: ", error);
        }
      }

      async function deleteFeedback(event, id) {
        event.stopPropagation();
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph·∫£n h·ªìi n√†y kh√¥ng?")) {
          try {
            await feedbackCollectionRef().doc(id).delete();
          } catch (error) {
            console.error("Error deleting feedback: ", error);
          }
        }
      }

      function initializeSeatingChart() {
        const leftBlock = document.getElementById("left-desk-block");
        const rightBlock = document.getElementById("right-desk-block");
        if (!leftBlock || !rightBlock) return;
        leftBlock.innerHTML = "";
        rightBlock.innerHTML = "";
        for (let i = 1; i <= 6; i++) {
          leftBlock.innerHTML += `<div class="desk"><div class="seat" data-seat-id="L-${i}-1"></div><div class="seat" data-seat-id="L-${i}-2"></div></div>`;
          rightBlock.innerHTML += `<div class="desk"><div class="seat" data-seat-id="R-${i}-1"></div><div class="seat" data-seat-id="R-${i}-2"></div></div>`;
        }
        document.querySelectorAll(".seat").forEach((seat) => {
          seat.addEventListener("dragover", handleDragOver);
          seat.addEventListener("dragleave", handleDragLeave);
          seat.addEventListener("drop", handleSeatDrop);
          seat.addEventListener("dragstart", handleSeatDragStart);
        });
        if (unassignedStudentsList) {
          unassignedStudentsList.addEventListener("dragover", handleDragOver);
          unassignedStudentsList.addEventListener("dragleave", handleDragLeave);
          unassignedStudentsList.addEventListener("drop", handleUnassignedDrop);
        }
      }

      function renderSeatingChart() {
        if (!unassignedStudentsList) return;
        document.querySelectorAll(".seat").forEach((s) => {
          s.innerHTML = "";
          s.classList.remove("occupied");
          s.draggable = false;
          delete s.dataset.studentId;
        });
        unassignedStudentsList.innerHTML = "";
        const unassigned = students.filter((s) => !s.seatId);
        const assigned = students.filter((s) => s.seatId);
        unassigned.forEach((student) => {
          const card = document.createElement("div");
          card.id = student.id;
          card.className = "student-card text-center";
          card.draggable = currentUserRole !== "VIEWER";
          card.innerHTML = `<div class="student-id">${student.id}</div><div class="student-name text-xs truncate">${student.name}</div>`;
          card.addEventListener("dragstart", handleDragStart);
          card.addEventListener("dragend", handleDragEnd);
          unassignedStudentsList.appendChild(card);
        });
        assigned.forEach((student) => {
          const seat = document.querySelector(
            `.seat[data-seat-id="${student.seatId}"]`
          );
          if (seat) {
            seat.classList.add("occupied");
            seat.draggable = currentUserRole !== "VIEWER";
            seat.dataset.studentId = student.id;
            seat.innerHTML = `<div class="student-in-seat"><span class="font-bold">${student.id}</span><br>${student.name}</div>`;
          }
        });
      }

      async function handleSeatDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");
        const droppedId = event.dataTransfer.getData("text/plain");
        const targetId = event.currentTarget.dataset.seatId;
        const studentInSeatId = event.currentTarget.dataset.studentId;
        const droppedStudent = students.find((s) => s.id === droppedId);
        if (!droppedStudent) return;
        const oldSeatId = droppedStudent.seatId;
        if (studentInSeatId) {
          const studentInSeat = students.find((s) => s.id === studentInSeatId);
          if (studentInSeat) studentInSeat.seatId = oldSeatId;
        } else if (oldSeatId) {
          const oldSeat = document.querySelector(
            `.seat[data-seat-id="${oldSeatId}"]`
          );
          if (oldSeat) delete oldSeat.dataset.studentId;
        }
        droppedStudent.seatId = targetId;
        await studentsDocRef().set({ students });
      }

      async function handleUnassignedDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");
        const droppedId = event.dataTransfer.getData("text/plain");
        const droppedStudent = students.find((s) => s.id === droppedId);
        if (droppedStudent && droppedStudent.seatId) {
          delete droppedStudent.seatId;
          await studentsDocRef().set({ students });
        }
      }

      const handleDragStart = (event) => {
        event.dataTransfer.setData("text/plain", event.target.id);
        setTimeout(() => {
          const el = document.getElementById(event.target.id);
          if (el) el.classList.add("dragging");
        }, 0);
      };
      const handleDragEnd = (event) => {
        const el = document.getElementById(event.target.id);
        if (el) el.classList.remove("dragging");
      };
      const handleDragOver = (event) => {
        event.preventDefault();
        event.currentTarget.classList.add("drag-over");
      };
      const handleDragLeave = (event) => {
        event.currentTarget.classList.remove("drag-over");
      };
      const handleSeatDragStart = (event) => {
        const studentId = event.currentTarget.dataset.studentId;
        if (studentId) {
          event.dataTransfer.setData("text/plain", studentId);
          setTimeout(() => event.target.classList.add("dragging"), 0);
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        initializeSeatingChart();
        // Generate spans for login background
        const loginBg = document.getElementById("login-background");
        for (let i = 0; i < 250; i++) {
          const span = document.createElement("span");
          loginBg.appendChild(span);
        }
      });
    </script>
  </body>
</html>
