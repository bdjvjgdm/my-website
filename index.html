<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω ƒêi·ªÉm Thi ƒêua</title>
    <!-- T√≠ch h·ª£p Tailwind CSS ƒë·ªÉ l√†m ƒë·∫πp giao di·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- T·∫£i c√°c th∆∞ vi·ªán Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Kh·ªüi t·∫°o Firebase sau khi t·∫£i SDK -->
    <script>
        // C·∫•u h√¨nh Firebase ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        const firebaseConfig = {
            apiKey: "AIzaSyDaeedEmbpGg_rr2ln13lWsXKY-opoy36E",
            authDomain: "quanlydiem-c2820.firebaseapp.com",
            projectId: "quanlydiem-c2820",
            storageBucket: "quanlydiem-c2820.appspot.com",
            messagingSenderId: "912711399959",
            appId: "1:912711399959:web:08e5897d6b958c1371fa52"
        };

        // Kh·ªüi t·∫°o c√°c d·ªãch v·ª• Firebase
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1557682250-33bd709cbe85?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%D');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .card { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .drop-zone { border: 2px dashed #cbd5e1; padding: 1rem; min-height: 150px; border-radius: 0.75rem; transition: background-color 0.2s, border-color 0.2s; }
        .drop-zone.drag-over { background-color: #f5f3ff; border-color: #7c3aed; }
        .student-card { cursor: grab; transition: transform 0.2s; position: relative; }
        .student-card:active { cursor: grabbing; transform: scale(1.05); }
        .student-card.dragging { opacity: 0.5; }
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            border: 2px solid white;
        }
        .student-card:hover .delete-btn {
            opacity: 1;
        }
        .fab {
            position: fixed;
            right: 30px;
            width: 60px;
            height: 60px;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .fab-main {
             background-color: #7c3aed;
             bottom: 30px;
        }
        .fab-secondary {
            background-color: #f59e0b;
            bottom: 100px;
        }
        .fab:hover {
            transform: scale(1.1);
        }
        .table-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-gray-200">

    <div class="min-h-screen flex items-center justify-center p-4">

        <!-- Trang ƒêƒÉng Nh·∫≠p -->
        <div id="login-page" class="w-full max-w-md">
            <div class="card shadow-2xl rounded-2xl p-8 space-y-6">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-800">ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</h1>
                    <p class="text-gray-600 mt-2">D√†nh cho c√°n b·ªô qu·∫£n l√Ω h·ªçc t·∫≠p</p>
                </div>
                 <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">T√™n ƒëƒÉng nh·∫≠p (Email)</label>
                        <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" placeholder="v√≠ d·ª•: to1@gmail.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u</label>
                        <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá.</div>
                <button onclick="handleLogin()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-bold text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 transition-transform transform hover:scale-105">
                    ƒêƒÉng Nh·∫≠p 
                </button>
            </div>
        </div>

        <!-- Trang Ch√≠nh - Qu·∫£n L√Ω -->
        <div id="main-page" class="hidden w-full max-w-6xl">
            <div class="card shadow-2xl rounded-2xl p-8 space-y-8">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">Trang Qu·∫£n L√Ω Thi ƒêua</h1>
                    <div class="text-right">
                         <div id="user-info" class="text-sm font-medium text-gray-700"></div>
                         <button onclick="handleLogout()" class="text-sm font-medium text-violet-600 hover:text-violet-500">ƒêƒÉng xu·∫•t</button>
                    </div>
                </div>
                
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Th√™m h·ªçc sinh</h2>
                            <div id="add-student-error" class="text-red-500 text-sm mb-2 hidden"></div>
                            <div class="flex flex-col sm:flex-row gap-4 items-end">
                                <div class="w-full">
                                    <label for="student-name" class="block text-sm font-medium text-gray-700">Nh·∫≠p t√™n h·ªçc sinh</label>
                                    <input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" placeholder="v√≠ d·ª•: Nguy·ªÖn VƒÉn An">
                                </div>
                                <button onclick="addStudent()" class="w-full sm:w-auto whitespace-nowrap px-6 py-2 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                    Th√™m
                                </button>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                             <h2 class="text-xl font-semibold text-gray-700 mb-4">2. C·ªông ƒëi·ªÉm thi ƒëua</h2>
                             <div id="add-points-error" class="text-red-500 text-sm mb-2 hidden"></div>
                             <div class="grid grid-cols-1 gap-4 items-end">
                                <div>
                                    <label for="student-id" class="block text-sm font-medium text-gray-700">M√£ h·ªçc sinh</label>
                                    <input type="text" id="student-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" placeholder="v√≠ d·ª•: HS1">
                                </div>
                                <div>
                                     <label for="points-to-add" class="block text-sm font-medium text-gray-700">S·ªë ƒëi·ªÉm c·ªông</label>
                                     <input type="number" id="points-to-add" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" placeholder="v√≠ d·ª•: 10">
                                </div>
                                <button onclick="addPoints()" class="w-full px-6 py-2 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                                    Th√™m ƒêi·ªÉm
                                </button>
                             </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <h2 class="text-xl font-semibold text-gray-700">B·∫£ng ƒëi·ªÉm thi ƒëua</h2>
                        <div class="bg-white p-4 rounded-lg border">
                            <h3 class="font-semibold text-center mb-2 text-gray-600">Ch∆∞a x·∫øp t·ªï</h3>
                            <div id="unassigned-zone" data-groupid="0" class="drop-zone min-h-[100px] grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold text-center mb-2 text-gray-800">T·ªï 1</h3>
                                <div id="group-1" data-groupid="1" class="drop-zone grid grid-cols-2 gap-2"></div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold text-center mb-2 text-gray-800">T·ªï 2</h3>
                                <div id="group-2" data-groupid="2" class="drop-zone grid grid-cols-2 gap-2"></div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold text-center mb-2 text-gray-800">T·ªï 3</h3>
                                <div id="group-3" data-groupid="3" class="drop-zone grid grid-cols-2 gap-2"></div>
                            </div>
                             <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold text-center mb-2 text-gray-800">T·ªï 4</h3>
                                <div id="group-4" data-groupid="4" class="drop-zone grid grid-cols-2 gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pt-6 border-t border-gray-200 text-center space-y-4">
                    <button onclick="showSummary()" class="w-full max-w-xs mx-auto py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-bold text-gray-800 bg-yellow-400 hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition-transform transform hover:scale-105">
                        T·ªïng K·∫øt X·∫øp H·∫°ng H·ªçc Sinh
                    </button>
                    <!-- N√∫t m·ªõi cho Admin -->
                    <button id="finalize-week-button" onclick="openFinalizeWeekModal()" class="hidden w-full max-w-xs mx-auto py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Ch·ªët ƒêi·ªÉm & B·∫Øt ƒê·∫ßu Tu·∫ßn M·ªõi
                    </button>
                    <button id="clear-data-button" onclick="openClearDataModal()" class="hidden w-full max-w-xs mx-auto py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-bold text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        X√≥a To√†n B·ªô D·ªØ Li·ªáu
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Trang T·ªïng K·∫øt X·∫øp H·∫°ng H·ªçc Sinh -->
        <div id="summary-page" class="hidden w-full max-w-2xl">
             <div class="card shadow-2xl rounded-2xl p-8 space-y-6">
                <h1 class="text-3xl font-bold text-center text-gray-800">B·∫£ng X·∫øp H·∫°ng Tu·∫ßn</h1>
                <p class="text-center text-gray-600">Top 10 h·ªçc sinh c√≥ ƒëi·ªÉm thi ƒëua cao nh·∫•t.</p>
                <div id="top-10-list-container" class="space-y-4"></div>
                <div class="text-center pt-4">
                     <button onclick="goBackToMain()" class="px-6 py-2 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Quay L·∫°i Trang Qu·∫£n L√Ω
                    </button>
                </div>
             </div>
        </div>
        
        <!-- Trang B·∫£ng ƒêi·ªÉm Chi Ti·∫øt -->
        <div id="scoring-table-page" class="hidden w-full max-w-screen-xl">
             <div class="card shadow-2xl rounded-2xl p-6 md:p-8 space-y-6">
                <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">B·∫£ng Ch·∫•m ƒêi·ªÉm Thi ƒêua Chi Ti·∫øt</h1>
                <div class="overflow-x-auto">
                    <table id="detailed-scoring-table" class="min-w-full bg-white border border-gray-300 text-xs md:text-sm">
                        <thead class="bg-gray-100 text-xs">
                            <tr>
                                <th rowspan="3" class="w-20">T·ªï</th>
                                <th rowspan="3">1. Tr·∫£ l·∫°i c·ªßa r∆°i khi nh·∫∑t ƒë∆∞·ª£c (+10ƒë)</th>
                                <th rowspan="3">2. Lao ƒë·ªông t√¨nh nguy·ªán, ƒë∆∞·ª£c vƒÉn ngh·ªá (+15ƒë)</th>
                                <th rowspan="3">3. C√≥ b√†i ph√°t thanh, tuy√™n truy·ªÅn (+10ƒë)</th>
                                <th rowspan="3">4. Ph√°t hi·ªán h√†nh vi sai tr√°i tr√™n MXH (+5ƒë/l·∫ßn/hs)</th>
                                <th class="bg-green-100">5. Tham gia c√°c cu·ªôc thi v·ªÅ vƒÉn h√≥a, l·ªãch s·ª≠,...; c√¥ng t√°c qu·∫£n l√Ω h·ªì s∆°, s·ªï ƒëo√†n, n·ªôp danh s√°ch,...; c√°c ho·∫°t ƒë·ªông quy√™n g√≥p t·ª´ thi·ªán, ƒêo√†n ph√≠, c√°c kho·∫£n thu kh√°c</th>
                                <th colspan="5">6. Tham gia c√°c ho·∫°t ƒë·ªông phong tr√†o vƒÉn ngh·ªá, TDTT, HSG, KHKT c·∫•p huy·ªán/t·ªânh ƒë·∫°t gi·∫£i:</th>
                                <th colspan="4">7. Tham gia ƒë·ªôi tuy·ªÉn HSG, ƒë·ªôi vƒÉn ngh·ªá, ƒë·ªôi TDTT c·∫•p tr∆∞·ªùng ƒë·∫°t gi·∫£i:</th>
                                <th rowspan="3">GI·ªú H·ªåC T·ªêT</th>
                                <th rowspan="3" class="bg-yellow-100">ƒêi·ªÉm c·ªông</th>
                            </tr>
                            <tr>
                                <th rowspan="2" class="bg-green-100 align-middle">ƒê·∫ßy ƒë·ªß, ƒë√∫ng th·ªùi h·∫°n, c√≥ ch·∫•t l∆∞·ª£ng (+10ƒë)</th>
                                <th colspan="5">K·∫øt qu·∫£</th>
                                <th colspan="4">K·∫øt qu·∫£</th>
                            </tr>
                             <tr>
                                <th>Nh·∫•t/HCV (+15ƒë/hs)</th>
                                <th>Nh√¨/HCB (+12ƒë/hs)</th>
                                <th>Ba/HCƒê (+10ƒë/hs)</th>
                                <th>Khuy·∫øn kh√≠ch (+7ƒë/hs)</th>
                                <th>C√≥ tham gia (+5ƒë/hs)</th>
                                <th>Nh·∫•t (+10ƒë/gi·∫£i)</th>
                                <th>Nh√¨ (+8ƒë/gi·∫£i)</th>
                                <th>Ba (+7ƒë/gi·∫£i)</th>
                                <th>Khuy·∫øn kh√≠ch (+5ƒë/gi·∫£i)</th>
                            </tr>
                        </thead>
                        <tbody id="scoring-table-body">
                            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center pt-4">
                     <button onclick="goBackToMain()" class="px-6 py-2 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Quay L·∫°i Trang Qu·∫£n L√Ω
                    </button>
                </div>
             </div>
        </div>

        <!-- Trang M·ªõi: T·ªïng K·∫øt Tu·∫ßn & NƒÉm -->
        <div id="monthly-summary-page" class="hidden w-full max-w-6xl">
            <div class="card shadow-2xl rounded-2xl p-6 md:p-8 space-y-8">
                <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">T·ªïng K·∫øt Thi ƒêua C√°c Tu·∫ßn</h1>
                
                <div id="weekly-summary-container" class="space-y-6 max-h-[400px] overflow-y-auto pr-4">
                    <!-- K·∫øt qu·∫£ c√°c tu·∫ßn s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                </div>

                <div id="yearly-summary-section" class="pt-8 border-t-2 border-dashed border-gray-300">
                    <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-6">T·ªïng K·∫øt NƒÉm H·ªçc</h2>
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <label for="total-weeks-input" class="font-semibold">S·ªë tu·∫ßn h·ªçc th·ª±c t·∫ø (n):</label>
                        <div class="flex items-center gap-2">
                           <span id="total-weeks-display" class="text-2xl font-bold text-violet-600 w-12 text-center">0</span>
                           <button id="increment-n-button" onclick="incrementN()" class="hidden w-10 h-10 bg-gray-200 text-gray-800 rounded-full text-xl font-bold hover:bg-gray-300">+</button>
                        </div>
                    </div>
                     <div class="text-center">
                        <button onclick="calculateYearlySummary()" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700">
                           T√≠nh T·ªïng K·∫øt NƒÉm
                        </button>
                    </div>
                    <div id="yearly-summary-results" class="mt-6 space-y-4"></div>
                </div>

                <div class="text-center pt-4">
                     <button onclick="goBackToMain()" class="px-6 py-2 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Quay L·∫°i Trang Qu·∫£n L√Ω
                    </button>
                </div>
            </div>
        </div>

    </div>
    
    <!-- C√°c n√∫t FAB -->
    <div id="fab-container" class="hidden">
        <div id="fab-summary-button" onclick="showMonthlySummaryPage()" class="fab fab-secondary" title="Xem t·ªïng k·∫øt tu·∫ßn/nƒÉm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div id="fab-table-button" onclick="showScoringTablePage()" class="fab fab-main" title="M·ªü b·∫£ng ƒëi·ªÉm chi ti·∫øt">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
    </div>
    
    <!-- C√°c Modals -->
     <div id="clear-data-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white space-y-6 text-center">
            <h3 class="text-2xl font-bold text-gray-900">X√°c nh·∫≠n X√≥a D·ªØ Li·ªáu</h3>
            <div class="mt-4 px-7 py-3">
                <p class="text-md text-gray-600">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò d·ªØ li·ªáu h·ªçc sinh v√† ƒëi·ªÉm chi ti·∫øt kh√¥ng? <strong class="text-red-600">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</strong></p>
            </div>
            <div class="items-center px-4 py-3 space-x-4">
                <button onclick="clearAllData()" class="px-6 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">X√°c nh·∫≠n X√≥a</button>
                <button onclick="closeClearDataModal()" class="px-6 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">H·ªßy</button>
            </div>
        </div>
    </div>
    <div id="delete-student-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
         <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white space-y-6 text-center">
            <h3 class="text-2xl font-bold text-gray-900">X√°c nh·∫≠n X√≥a H·ªçc Sinh</h3>
            <div class="mt-4 px-7 py-3">
                <p id="delete-student-confirm-text" class="text-md text-gray-600"></p>
            </div>
            <div class="items-center px-4 py-3 space-x-4">
                <button onclick="confirmDeleteStudent()" class="px-6 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">X√≥a</button>
                <button onclick="closeDeleteStudentModal()" class="px-6 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">H·ªßy</button>
                <input type="hidden" id="student-id-to-delete">
            </div>
        </div>
    </div>
     <div id="finalize-week-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-2xl bg-white space-y-6 text-center">
            <h3 class="text-2xl font-bold text-gray-900">X√°c nh·∫≠n Ch·ªët ƒêi·ªÉm Tu·∫ßn</h3>
            <div id="finalize-week-summary" class="mt-4 text-left p-4 bg-gray-50 rounded-lg"></div>
            <p class="text-md text-gray-600 mt-4">B·∫°n c√≥ mu·ªën reset ƒëi·ªÉm c·ªßa t·∫•t c·∫£ h·ªçc sinh v·ªÅ 0 ƒë·ªÉ b·∫Øt ƒë·∫ßu tu·∫ßn m·ªõi kh√¥ng?</p>
            <div class="items-center px-4 py-3 space-x-4">
                <button onclick="confirmFinalizeWeek(true)" class="px-6 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700">L∆∞u v√† Reset</button>
                <button onclick="confirmFinalizeWeek(false)" class="px-6 py-2 bg-gray-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-700">Ch·ªâ L∆∞u</button>
                <button onclick="closeFinalizeWeekModal()" class="px-6 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">H·ªßy</button>
            </div>
        </div>
    </div>


    <script>
        // --- C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ---
        const predefinedUsers = {
            'to1@gmail.com': { role: 'T·ªï 1', groupId: 1 },
            'to2@gmail.com': { role: 'T·ªï 2', groupId: 2 },
            'to3@gmail.com': { role: 'T·ªï 3', groupId: 3 },
            'to4@gmail.com': { role: 'T·ªï 4', groupId: 4 },
            'admin@check.com': { role: 'ADMIN', groupId: null }
        };
        
        let students = [];
        let scoringData = {};
        let weeklySummaries = { weeks: [], totalWeeks: 0 };
        let unsubscribeStudents, unsubscribeScoring, unsubscribeWeekly; 
        let currentUserRole = null;
        let currentUserGroupId = null;
        
        const studentsDocRef = () => db.collection("classes").doc("mainClass");
        const scoringDocRef = () => db.collection("classes").doc("scoringTable");
        const weeklySummariesDocRef = () => db.collection("classes").doc("weeklySummaries");

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const mainPage = document.getElementById('main-page');
        const summaryPage = document.getElementById('summary-page');
        const scoringTablePage = document.getElementById('scoring-table-page');
        const monthlySummaryPage = document.getElementById('monthly-summary-page');
        const fabContainer = document.getElementById('fab-container');
        const loginError = document.getElementById('login-error');
        const addStudentError = document.getElementById('add-student-error');
        const addPointsError = document.getElementById('add-points-error');
        const top10ListContainer = document.getElementById('top-10-list-container');
        const userInfo = document.getElementById('user-info');
        const clearDataButton = document.getElementById('clear-data-button');
        const clearDataModal = document.getElementById('clear-data-modal');
        const deleteStudentModal = document.getElementById('delete-student-modal');
        const finalizeWeekButton = document.getElementById('finalize-week-button');
        const finalizeWeekModal = document.getElementById('finalize-week-modal');
        const incrementNButton = document.getElementById('increment-n-button');

        // --- L∆ØU TR·ªÆ D·ªÆ LI·ªÜU V·ªöI FIRESTORE ---
        async function saveStudentsData() {
            try {
                await studentsDocRef().set({ students: students });
            } catch (error) {
                console.error("L·ªói khi l∆∞u d·ªØ li·ªáu h·ªçc sinh: ", error);
            }
        }
        
        async function saveScoringData() {
             try {
                await scoringDocRef().set(scoringData, { merge: true });
            } catch (error) {
                console.error("L·ªói khi l∆∞u d·ªØ li·ªáu b·∫£ng ƒëi·ªÉm: ", error);
            }
        }

        function listenForDataChanges() {
            if (unsubscribeStudents) unsubscribeStudents();
            unsubscribeStudents = studentsDocRef().onSnapshot(doc => {
                students = doc.exists ? (doc.data().students || []) : [];
                renderStudentList();
            });

            if (unsubscribeScoring) unsubscribeScoring();
            unsubscribeScoring = scoringDocRef().onSnapshot(doc => {
                scoringData = doc.exists ? (doc.data() || {}) : {};
                if(!scoringTablePage.classList.contains('hidden')) renderScoringTable();
            });

            if (unsubscribeWeekly) unsubscribeWeekly();
            unsubscribeWeekly = weeklySummariesDocRef().onSnapshot(doc => {
                 weeklySummaries = doc.exists ? (doc.data() || { weeks: [], totalWeeks: 0 }) : { weeks: [], totalWeeks: 0 };
                 if(!monthlySummaryPage.classList.contains('hidden')) renderMonthlySummaryPage();
            });
        }


        // --- X√ÅC TH·ª∞C V√Ä ƒêI·ªÄU H∆Ø·ªöNG ---
        auth.onAuthStateChanged(user => {
            const allPages = [mainPage, summaryPage, scoringTablePage, monthlySummaryPage];
            if (user) {
                const userData = predefinedUsers[user.email.toLowerCase()];
                if(userData) {
                    currentUserRole = userData.role;
                    currentUserGroupId = userData.groupId;
                    userInfo.innerHTML = `<strong>${user.email}</strong> [${currentUserRole}]`;
                }

                const isAdmin = currentUserRole === 'ADMIN';
                clearDataButton.classList.toggle('hidden', !isAdmin);
                finalizeWeekButton.classList.toggle('hidden', !isAdmin);
                
                loginPage.classList.add('hidden');
                mainPage.classList.remove('hidden');
                fabContainer.classList.remove('hidden');
                listenForDataChanges();
            } else {
                if (unsubscribeStudents) unsubscribeStudents();
                if (unsubscribeScoring) unsubscribeScoring();
                if (unsubscribeWeekly) unsubscribeWeekly();
                
                currentUserRole = null;
                currentUserGroupId = null;
                allPages.forEach(page => page.classList.add('hidden'));
                fabContainer.classList.add('hidden');
                loginPage.classList.remove('hidden');
            }
        });
        
        async function handleLogin() {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.classList.add('hidden');

            if (!email || !password) {
                 loginError.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u.";
                 loginError.classList.remove('hidden');
                 return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                     loginError.textContent = "T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.";
                } else {
                    loginError.textContent = `L·ªói: ${error.message}`;
                }
                loginError.classList.remove('hidden');
            }
        }
        
        async function handleLogout() {
            await auth.signOut();
        }
        
        function showPage(pageToShow) {
            const allPages = [mainPage, summaryPage, scoringTablePage, monthlySummaryPage];
            allPages.forEach(p => p.classList.add('hidden'));
            pageToShow.classList.remove('hidden');
            
            const isMainPage = pageToShow === mainPage;
            fabContainer.classList.toggle('hidden', !isMainPage);
        }

        const goBackToMain = () => showPage(mainPage);
        const showSummary = () => {
             if (students.length === 0) return alert('Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc sinh.');
             const sortedStudents = [...students].sort((a, b) => b.score - a.score);
             renderTop10List(sortedStudents.slice(0, 10));
             showPage(summaryPage);
        };
        const showScoringTablePage = () => {
            renderScoringTable();
            showPage(scoringTablePage);
        };
        const showMonthlySummaryPage = () => {
            renderMonthlySummaryPage();
            showPage(monthlySummaryPage);
        }

        // --- CH·ª®C NƒÇNG QU·∫¢N L√ù D·ªÆ LI·ªÜU (ADMIN) ---
        function openClearDataModal() { clearDataModal.classList.remove('hidden'); }
        function closeClearDataModal() { clearDataModal.classList.add('hidden'); }

        async function clearAllData() {
            await studentsDocRef().set({ students: [] });
            await scoringDocRef().set({});
            await weeklySummariesDocRef().set({ weeks: [], totalWeeks: 0 });
            closeClearDataModal();
        }

        function openDeleteStudentModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if(student) {
                document.getElementById('delete-student-confirm-text').innerHTML = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh <br><strong class="text-lg">${student.name} (${student.id})</strong>?`;
                document.getElementById('student-id-to-delete').value = studentId;
                deleteStudentModal.classList.remove('hidden');
            }
        }

        function closeDeleteStudentModal() { deleteStudentModal.classList.add('hidden'); }
        
        async function confirmDeleteStudent() {
            const studentId = document.getElementById('student-id-to-delete').value;
            students = students.filter(s => s.id !== studentId);
            await saveStudentsData();
            closeDeleteStudentModal();
        }
        
        // --- CH·ª®C NƒÇNG CH·ªêT ƒêI·ªÇM TU·∫¶N ---
        function openFinalizeWeekModal() {
            const summaryDiv = document.getElementById('finalize-week-summary');
            summaryDiv.innerHTML = '<p class="font-bold mb-2">ƒêi·ªÉm t·ªïng k·∫øt tu·∫ßn n√†y:</p>';
            let groupScores = { 1: 0, 2: 0, 3: 0, 4: 0 };

            students.forEach(s => {
                if(s.group >= 1 && s.group <= 4) {
                    groupScores[s.group] += s.score;
                }
            });

            for (let i = 1; i <= 4; i++) {
                summaryDiv.innerHTML += `<p><strong>T·ªï ${i}:</strong> ${groupScores[i]} ƒëi·ªÉm</p>`;
            }
            finalizeWeekModal.classList.remove('hidden');
        }

        function closeFinalizeWeekModal() {
            finalizeWeekModal.classList.add('hidden');
        }
        
        async function confirmFinalizeWeek(shouldReset) {
            let groupScores = { 1: 0, 2: 0, 3: 0, 4: 0 };
             students.forEach(s => {
                if(s.group >= 1 && s.group <= 4) groupScores[s.group] += s.score;
            });

            const newWeekData = {
                weekNumber: (weeklySummaries.weeks?.length || 0) + 1,
                timestamp: new Date().toISOString(),
                scores: groupScores
            };

            const updatedWeeks = [...(weeklySummaries.weeks || []), newWeekData];
            await weeklySummariesDocRef().set({ ...weeklySummaries, weeks: updatedWeeks }, { merge: true });
            
            if(shouldReset) {
                students.forEach(s => s.score = 0);
                await studentsDocRef().update({ students: students });
                alert("ƒê√£ l∆∞u v√† reset ƒëi·ªÉm th√†nh c√¥ng!");
            } else {
                alert("ƒê√£ l∆∞u ƒëi·ªÉm tu·∫ßn th√†nh c√¥ng!");
            }
            closeFinalizeWeekModal();
        }

        // --- CH·ª®C NƒÇNG T·ªîNG K·∫æT NƒÇM ---
        function renderMonthlySummaryPage() {
            const container = document.getElementById('weekly-summary-container');
            container.innerHTML = '';
            
            if (!weeklySummaries.weeks || weeklySummaries.weeks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu tu·∫ßn n√†o ƒë∆∞·ª£c l∆∞u.</p>';
            } else {
                 [...weeklySummaries.weeks].reverse().forEach(week => {
                    const sortedGroups = Object.entries(week.scores).sort((a, b) => b[1] - a[1]);
                    let weekHTML = `<div class="p-4 border rounded-lg bg-white">
                                        <h3 class="font-bold text-lg mb-2">Tu·∫ßn ${week.weekNumber}</h3><ul>`;
                    sortedGroups.forEach(([groupId, score], index) => {
                        weekHTML += `<li class="flex justify-between items-center p-1 ${index === 0 ? 'font-semibold text-violet-600' : ''}">
                                        <span>${index + 1}. T·ªï ${groupId}</span>
                                        <span>${score} ƒëi·ªÉm</span>
                                     </li>`;
                    });
                    weekHTML += '</ul></div>';
                    container.innerHTML += weekHTML;
                });
            }

            document.getElementById('total-weeks-display').textContent = weeklySummaries.totalWeeks || 0;
            incrementNButton.classList.toggle('hidden', currentUserRole !== 'ADMIN');
        }

        async function incrementN() {
            const newN = (weeklySummaries.totalWeeks || 0) + 1;
            await weeklySummariesDocRef().set({ totalWeeks: newN }, { merge: true });
        }

        function calculateYearlySummary() {
            const resultsDiv = document.getElementById('yearly-summary-results');
            resultsDiv.innerHTML = '';
            const n = weeklySummaries.totalWeeks || 0;
            if(n === 0) {
                 resultsDiv.innerHTML = '<p class="text-center text-red-500">Vui l√≤ng thi·∫øt l·∫≠p s·ªë tu·∫ßn h·ªçc (n) tr∆∞·ªõc khi t√≠nh.</p>';
                 return;
            }
            if (!weeklySummaries.weeks || weeklySummaries.weeks.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-red-500">Kh√¥ng c√≥ d·ªØ li·ªáu tu·∫ßn ƒë·ªÉ t·ªïng k·∫øt.</p>';
                return;
            }
            
            let yearlyScores = { 1: 0, 2: 0, 3: 0, 4: 0 };
            weeklySummaries.weeks.forEach(week => {
                for (let i = 1; i <= 4; i++) {
                    yearlyScores[i] += week.scores[i] || 0;
                }
            });

            const sortedYearly = Object.entries(yearlyScores).sort((a, b) => b[1] - a[1]);
            const threshold = 1000 * n;
            let resultHTML = `<h4 class="font-bold text-center">K·∫øt qu·∫£ x·∫øp h·∫°ng nƒÉm (d·ª±a tr√™n ${weeklySummaries.weeks.length} tu·∫ßn ƒë√£ l∆∞u):</h4>`;
            sortedYearly.forEach(([groupId, score], index) => {
                const isBelowThreshold = score < threshold;
                resultHTML += `<div class="p-4 border rounded-lg ${isBelowThreshold ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-lg">${index + 1}. T·ªï ${groupId}</span>
                                    <span class="font-bold text-xl ${isBelowThreshold ? 'text-red-600' : 'text-green-600'}">${score} ƒëi·ªÉm</span>
                                </div>
                                ${isBelowThreshold ? `<p class="text-sm text-red-700 mt-1">Th·∫•p h∆°n m·ª©c ƒëi·ªÉm chu·∫©n ${threshold} ƒëi·ªÉm.</p>` : ''}
                               </div>`;
            });
            resultsDiv.innerHTML = resultHTML;
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN CH√çNH ---
        async function addStudent() {
            const nameInput = document.getElementById('student-name');
            const name = nameInput.value.trim();

            addStudentError.classList.add('hidden');
            if (!name) {
                addStudentError.textContent = 'T√™n h·ªçc sinh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.';
                addStudentError.classList.remove('hidden');
                return;
            }

            const existingIds = students.map(s => parseInt(s.id.replace('HS', ''), 10));
            const maxId = existingIds.length > 0 ? Math.max(...existingIds) : 0;
            const newId = `HS${maxId + 1}`;

            students.push({ id: newId, name, group: 0, score: 0 });
            nameInput.value = '';
            nameInput.focus();
            await saveStudentsData();
        }

        async function addPoints() {
            const studentIdInput = document.getElementById('student-id');
            const pointsInput = document.getElementById('points-to-add');
            const studentId = studentIdInput.value.trim().toUpperCase();
            const points = parseInt(pointsInput.value, 10);
            
            addPointsError.classList.add('hidden');
            if (!studentId || isNaN(points)) {
                addPointsError.textContent = 'Vui l√≤ng nh·∫≠p M√£ v√† ƒêi·ªÉm h·ª£p l·ªá.';
                addPointsError.classList.remove('hidden');
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) {
                addPointsError.textContent = `Kh√¥ng t√¨m th·∫•y h·ªçc sinh m√£ "${studentId}".`;
                addPointsError.classList.remove('hidden');
                return;
            }
            
            const isAdmin = currentUserRole === 'ADMIN';
            const canAddPoints = isAdmin || (student.group === currentUserGroupId);

            if (!canAddPoints) {
                 addPointsError.textContent = `B·∫°n kh√¥ng c√≥ quy·ªÅn c·ªông ƒëi·ªÉm cho T·ªï ${student.group}.`;
                 addPointsError.classList.remove('hidden');
                 return;
            }

            student.score += points;
            studentIdInput.value = '';
            pointsInput.value = '';
            await saveStudentsData();
        }
        
        // --- K√âO TH·∫¢ ---
        async function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            const studentId = event.dataTransfer.getData('text/plain');
            const newGroupId = parseInt(event.currentTarget.dataset.groupid, 10);
            const student = students.find(s => s.id === studentId);
            if (student && student.group !== newGroupId) {
                student.group = newGroupId;
                await saveStudentsData();
            }
        }

        function handleDragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.id);
            setTimeout(() => { event.target.classList.add('dragging'); }, 0);
        }
        function handleDragEnd(event) { event.target.classList.remove('dragging'); }
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        function handleDragLeave(event) { event.currentTarget.classList.remove('drag-over'); }
        
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
        });
        
        // --- C√ÅC H√ÄM HI·ªÇN TH·ªä D·ªÆ LI·ªÜU (RENDER) ---
        function renderStudentList() {
            document.querySelectorAll('.student-card').forEach(card => card.remove());
            
            students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.id = student.id;
                studentCard.className = 'student-card p-2 bg-gray-100 rounded-md text-center border shadow-sm';
                studentCard.draggable = true;

                let deleteButtonHTML = '';
                if (currentUserRole === 'ADMIN') {
                    deleteButtonHTML = `<div class="delete-btn" onclick="openDeleteStudentModal('${student.id}')" title="X√≥a h·ªçc sinh">√ó</div>`;
                }

                studentCard.innerHTML = `
                    <div class="font-bold text-gray-800 text-sm">${student.id}</div>
                    <div class="text-gray-600 text-xs truncate" title="${student.name}">${student.name}</div>
                    <div class="text-violet-600 font-semibold">${student.score}ƒë</div>
                    ${deleteButtonHTML}
                `;
                studentCard.addEventListener('dragstart', handleDragStart);
                studentCard.addEventListener('dragend', handleDragEnd);

                const targetZone = document.querySelector(`.drop-zone[data-groupid="${student.group}"]`);
                if (targetZone) {
                    targetZone.appendChild(studentCard);
                }
            });
        }
        
        function renderTop10List(top10) {
            top10ListContainer.innerHTML = '';
            if (top10.length === 0) {
                top10ListContainer.innerHTML = '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                return;
            }
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            top10.forEach((student, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'flex items-center p-4 rounded-lg border';
                let rankContent;
                if (index < 3) {
                     rankItem.className += ' bg-yellow-50 border-yellow-200';
                     rankContent = `<div class="text-3xl w-10 text-center">${medals[index]}</div>`;
                } else {
                     rankItem.className += ' bg-gray-50 border-gray-200';
                     rankContent = `<div class="text-xl font-bold text-gray-500 w-10 text-center">${index + 1}</div>`;
                }
                const groupText = student.group === 0 ? 'Ch∆∞a x·∫øp' : `T·ªï ${student.group}`;
                rankItem.innerHTML = `
                    ${rankContent}
                    <div class="ml-4 flex-grow">
                        <p class="font-bold text-gray-800 text-lg">${student.name}</p>
                        <p class="text-sm text-gray-500">${student.id} - ${groupText}</p>
                    </div>
                    <div class="text-xl font-bold text-violet-600">${student.score} ƒëi·ªÉm</div>
                `;
                top10ListContainer.appendChild(rankItem);
            });
        }
        
        // --- TRANG CH·∫§M ƒêI·ªÇM CHI TI·∫æT SCRIPT ---
        const scoreCriteria = [
            'cua_roi', 'lao_dong', 'phat_thanh', 'mxh', 'cuoc_thi_chat_luong',
            'phong_trao_nhat', 'phong_trao_nhi', 'phong_trao_ba', 'phong_trao_kk', 'phong_trao_tham_gia',
            'hsg_nhat', 'hsg_nhi', 'hsg_ba', 'hsg_kk', 'gio_hoc_tot'
        ];

        function renderScoringTable() {
            const tableBody = document.getElementById('scoring-table-body');
            tableBody.innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                const groupId = `group${i}`;
                const row = document.createElement('tr');
                let rowHTML = `<td class="font-bold">T·ªï ${i}</td>`;
                
                scoreCriteria.forEach(criterion => {
                    const value = scoringData[groupId]?.[criterion] || '';
                    rowHTML += `<td><input type="number" class="table-input" value="${value}" oninput="handleScoreInputChange(this, '${groupId}', '${criterion}')" min="0"></td>`;
                });
                
                rowHTML += `<td id="total-score-${groupId}" class="font-bold bg-yellow-100">0</td>`;
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
                calculateRowTotal(groupId);
            }
        }

        function calculateRowTotal(groupId) {
            let total = 0;
            const groupData = scoringData[groupId] || {};
            for (const criterion of scoreCriteria) {
                total += Number(groupData[criterion] || 0);
            }
            document.getElementById(`total-score-${groupId}`).textContent = total;
        }

        async function handleScoreInputChange(inputElement, groupId, criterion) {
            const value = inputElement.value;
            if (!scoringData[groupId]) {
                scoringData[groupId] = {};
            }
            scoringData[groupId][criterion] = Number(value);
            calculateRowTotal(groupId);
            await saveScoringData();
        }
    </script>
</body>
</html>

